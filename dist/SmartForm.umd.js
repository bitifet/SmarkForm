!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).SmartForm={})}(this,(function(t){"use strict";const e=Symbol("Events");class n{constructor(){this[e]=new Set}on(t,n){const r=this;r[e].has(t)||r[e].set(t,[]),r[e].get(t).push(n.bind(r))}emit(t,n){const r=this;if(r[e].has(t))for(const o of r[e].get(t))o(n);else console.error("".concat(r.constructor.name," has no handler for ").concat(t," action"))}}const r={},o=Symbol("smart_component"),i=/^[a-z0-9_]+$/i,s=/[\*\?]/,a=class extends Error{constructor(t,e,n){super("RenderError(".concat(n,"): ").concat(e)),this.code=t,this.path=n,this.stack=this.stack.split("\n").slice(2).join("\n")}},l=class extends Error{constructor(t,e,n){super("RuleError(".concat(n,"): ").concat(e)),this.code=t,this.path=n,this.stack=this.stack.split("\n").slice(2).join("\n")}};class c extends n{constructor(t){let{property_name:e="smart",...n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;super();const s=this;if(s.validName=function(){let t=0;return function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(let t of n)if("string"==typeof t&&(t=t.trim(),t.length))return t;return"UNNAMED"+ ++t}}(),s.property_name=e,s.selector="[data-".concat(s.property_name,"]"),s.typeName=s.constructor.name,s.components=r,s.target=t,s.options=n,s.setNodeOptions(s.target,s.options),s.parent=i,!s.parent instanceof c)throw s.renderError("INVALID_PARENT","Smart Components must have valid Smart Component parent.");s.root=null===s.parent?s:s.parent,s.parents={},s.parents[Symbol.iterator]=function*(){let t=s;for(;t;)yield t,t=t.parent},s.onRenderedTasks=[],s.children={},s.target[o]=s,s.render(),s.onRenderedTasks.forEach((t=>t())),s.onRenderedTasks=null}onRendered(t){const e=this;e.onRenderedTasks?e.onRenderedTasks.push(t):t()}getNodeOptions(t,e){const n=(t.dataset[this.property_name]||"").trim()||null,r={...e,...(()=>{try{const t=JSON.parse(n);if("object"!=typeof t)throw new Error("NO_OBJECT");return t}catch(t){return n.match(i)?{type:n}:{}}})()};return r.action||r.type||(r.type="input"),this.setNodeOptions(t,r),r}setNodeOptions(t,e){t.dataset[this.property_name]=JSON.stringify(e)}enhance(t,e){const n=this;let r=n.getNodeOptions(t,e);if(r.action){if(r.type||(r.type="action"),"action"!=r.type)throw n.renderError("WRONG_ACTION_TYPE",'Actions must be of type "action" but "'.concat(r.type,'" given.'));delete r.name}else if("string"!=typeof r.type)throw n.renderError("NO_TYPE_PROVIDED","Invalid SmartFom item: type is mandatory for non action elements.");const o=n.components[r.type];if(!o)throw n.renderError("UNKNOWN_TYPE","Unimplemented SmartForm component controller: ".concat(r.type));return new o(t,r,n)}getComponent(t){return t[o]||t.parentElement.closest(this.selector)[o]||null}getPath(){return[...this.parents].map((t=>t.name)).reverse().join("/")||"/"}find(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=this;if("/"==t[0])for(;e.parent;)e=e.parent;const n=t.split("/").filter((t=>t)),r=n.findIndex((t=>t.match(s)));if(r>=0){const t=(o=n[r],new RegExp("^"+o.replace(/\*+/g,".*").replace(/\?/g,".")+"$")),i=n.slice(0,r).join("/"),s=n.slice(r+1).join("/"),a=e.find(i);return Object.entries(a.children).filter((e=>{let[n,r]=e;return r&&n.match(t)})).map((t=>{let[,e]=t;return e.find(s)})).flat(1/0)}var o;return n.reduce(((t,e)=>void 0===t?null:".."==e?t.parent:t.children[e]),e)}inherittedOption(t,e){const n=this;for(const e of n.parents)if(void 0!==e.options[t])return e.options[t];return e}moveTo(){const t=this;t.target.id||(t.target.id=t.getPath()),document.location.hash=t.target.id}getActions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const e=this,n=[];for(const r of[...e.root.target.querySelectorAll(e.selector)].map((t=>t[o]))){const o=r.getActionArgs();o&&(Object.is(o.context,e)&&(!t||1+[t].flat().findIndex((t=>t==o.action)))&&n.push(r))}return n}getActionArgs(){}renderError(t,e){return new a(t,e,this.getPath())}ruleError(t,e){return new l(t,e,this.getPath())}}function d(t,e){if(void 0!==r[t])throw new Error("Duplicate component type definition: ".concat(t));if(!(e.prototype instanceof c))throw new Error("Bad component type implementation for: ".concat(t));r[t]=e}class p extends c{render(){const t=this;t.originalDisplayProp=t.target.style.display;for(const e of function(t,e){const n=null===t.parentNode?t=>null===t:e=>null===e||e.isSameNode(t);return[...t.querySelectorAll(e)].filter((t=>n(t.parentNode.closest(e))))}(t.target,t.selector)){const n=t.enhance(e);"action"!=n.options.type&&(n.name=t.validName(n.options.name,e.getAttribute("name")),t.children[n.name]=n)}t.root.onRendered((()=>{t.fold({operation:t.options.folded?"fold":"unfold"})}))}export(){return Object.fromEntries(Object.entries(this.children).map((t=>{let[e,n]=t;return[e,n.export()]})))}import(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=Object(t).constructor;if(e!=={}.constructor)throw this.renderError("FORM_NOT_PLAIN_OBJECT","Expected plain object for form import, ".concat(e.name," given."));return Object.fromEntries(Object.entries(this.children).map((e=>{let[n,r]=e;return[n,r.import(t[n])]})))}isEmpty(){return 0>Object.values(this.children).findIndex((t=>!t.isEmpty()))}empty(){return this.import({})}fold(){let{operation:t="toggle"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this,n="none"==e.target.style.display,r="fold"==t||"unfold"!=t&&!n;e.target.style.display=r?"none":e.originalDisplayProp,e.getActions("fold").forEach((t=>{const{foldedClass:e,unfoldedClass:n}=t.options;e&&t.target.classList[r?"add":"remove"](e),n&&t.target.classList[r?"remove":"add"](n)}))}}class m extends p{render(){super.render();const t=Object.keys(this.children).length;if(1!=t)throw this.renderError("NOT_A_SINGLETON","Singleton forms are only allowed to contain exactly one"+" data field but ".concat(t," found."))}export(){return Object.values(super.export())[0]}import(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return super.import(Object.fromEntries([[Object.keys(this.children)[0],t]]))}empty(){this.import("")}}class h extends c{render(){const t=this;t.originalDisplayProp=t.target.style.display,t.min_items=Math.max(0,"number"==typeof t.options.min_items?t.options.min_items:1),t.max_items=Math.max(t.min_items,"number"==typeof t.options.max_items?t.options.max_items:1/0),t.children=[];const e=t.target.children.length;if(1!=e)throw t.renderError("LIST_WRONG_NUM_CHILDREN","List components must contain exactly 1 direct children, but ".concat(e," given"));if(t.itemTpl=t.target.children[0],null!==t.itemTpl.querySelector("[id]"))throw t.renderError("LIST_CONTAINS_ID","List components are not allowed to contain elements with 'id' attribute");const n=t.getNodeOptions(t.itemTpl,{type:t.options.of||"form"});if(t.options.of&&n.type!=t.options.of)throw t.renderError("LIST_ITEM_TYPE_MISSMATCH","List item type missmatch");t.itemTpl.remove(),t.root.onRendered((()=>{t.fold({operation:t.options.folded?"fold":"unfold"});for(let e=0;e<t.min_items;e++)t.addItem();0==t.min_items&&t.getActions("count").forEach((e=>e.target.innerText=String(t.children.length)))}))}export(){const t=this;return(t.inherittedOption("exportEmpties",!1)?t.children:t.children.filter((t=>!t.isEmpty()))).map((t=>t.export()))}import(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const e=this;!t instanceof Array&&(t=[t]);for(let n=0;n<Math.min(t.length,e.max_items);n++)e.children.length<=n&&e.addItem(),e.children[n].import(t[n]);for(let n=Math.max(t.length,e.min_items);n<e.children.length;)e.removeItem();for(let t=e.children.length;t<e.min_items;t++)e.chldren[t].empty();return t.length>e.max_items&&console.error("Max of ".concat(e.max_items," items exceeded by ").concat(t.length-e.max_items," while data loadig")),e.export()}addItem(){let{target:t,position:e="after",autoscroll:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this;if("after"!=e&&"before"!=e)throw r.renderError("LIST_WRONG_ADDITEM_POSITION","Invalid value for addItem() position property: ".concat(e));if(r.children.length>=r.max_items)throw r.ruleError("LIST_MAX_ITEMS_REACHED","Cannot add items over max_items boundary");const o=r.itemTpl.cloneNode(!0);let i;r.children.length?(t||(t="before"==e?r.children[0]:r.children[r.children.length-1]),r.children=r.children.map(((n,s)=>n.target.isSameNode(t.target)?"after"==e?(n.target.after(o),i=r.enhance(o,{type:"form"}),[n,i]):(n.target.before(o),i=r.enhance(o,{type:"form"}),[i,n]):n)).flat().map(((t,e)=>(t.name=e,t)))):(r.target.appendChild(o),i=r.enhance(o,{type:"form",name:0}),r.children.push(i)),r.getActions("count").forEach((t=>t.target.innerText=String(r.children.length)));const s=i?"self"==n?i:"parent"==n?i.parent:null:null;s&&s.moveTo()}removeItem(){let{target:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const n=this;let{keep_non_empty:r}=e;if(t||(t=[...n.children].reverse().find(((t,e)=>!r||t.isEmpty())),t||(t=n.children[n.children.length-1],r=!1)),t instanceof Array)return t.map((t=>n.removeItem({target:t,...e})));if(n.children.length<=n.min_items)switch(e.failback){case"none":break;case"clear":return void t.empty();default:throw n.ruleError("LIST_MIN_ITEMS_REACHED","Cannot remove items under min_items boundary")}r&&!t.isEmpty()||(n.children=n.children.filter((e=>!e.target.isSameNode(t.target)||(e.target.remove(),!1))).map(((t,e)=>(t.name=e,t))),n.getActions("count").forEach((t=>t.target.innerText=String(n.children.length))))}isEmpty(){return 0>this.children.findIndex((t=>!t.isEmpty()))}empty(){return this.import([])}fold(){let{operation:t="toggle"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this,n="none"==e.target.style.display,r="fold"==t||"unfold"!=t&&!n;e.target.style.display=r?"none":e.originalDisplayProp,e.getActions("fold").forEach((t=>{const{foldedClass:e,unfoldedClass:n}=t.options;e&&t.target.classList[r?"add":"remove"](e),n&&t.target.classList[r?"remove":"add"](n)})),e.getActions(["addItem","removeItem"]).map(r?t=>t.disable():t=>t.enable())}count(){}}class f extends c{render(){}export(){return this.target.value}import(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.target.value=t,this.target.value}isEmpty(){return!this.export().trim().length}empty(){this.import("")}}class u extends c{render(){}disable(){this.target.disabled=!0}enable(){this.target.disabled=!1}getActionArgs(){const t=this,e=[...t.parents],{action:n,for:r,to:o}=t.options;if(!n)return;let[i,s]=n.split(":").reverse();const a=r?t.parent.find(r):e.find((t=>(!s||t.typeName==s)&&"function"==typeof t[i])),l=o?a.find(o):r?null:e.find((t=>t.parent.target.isSameNode(a.target)));if("function"!=typeof a[i])throw t.renderError("UNKNOWN_ACTION","Unimplemented action ".concat(n)+(a?" for ".concat(a.options.type):""));return{action:i,origin:t,context:a,target:l,...t.options}}}function g(t){const e=this.getComponent(t.target).getActionArgs();if(!e)return;const{context:n,action:r}=e;n[r](e)}for(const[t,e]of Object.entries({form:p,singleton:m,action:u,list:h,input:f}))d(t,e);t.SmartForm=class extends p{constructor(t,e){const n={...e,name:"",type:"form"};super(t,n,null);const r=this;r.target.dataset[r.property_name]=n,r.target.addEventListener("click",g.bind(r),!0)}},t.createComponent=d,Object.defineProperty(t,"__esModule",{value:!0})}));