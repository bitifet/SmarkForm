!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).SmarkForm=t()}(this,(function(){"use strict";function e(e){if(Object(e)!==e)throw TypeError("right-hand side of 'in' should be an object, got "+(null!==e?typeof e:"null"));return e}function t(e,t,r){return(t=c(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function r(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function n(e){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?r(Object(o),!0).forEach((function(r){t(e,r,o[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function o(e,t){if(null==e)return{};var r,n,o=i(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.includes(r)||{}.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function i(e,t){if(null==e)return{};var r={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(t.includes(n))continue;r[n]=e[n]}return r}function a(e,t,r){"symbol"==typeof t&&(t=(t=t.description)?"["+t+"]":"");try{Object.defineProperty(e,"name",{configurable:!0,value:r?r+" "+t:t})}catch(e){}return e}function s(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function c(e){var t=s(e,"string");return"symbol"==typeof t?t:t+""}function l(){function t(e,t){return function(r){!function(e,t){if(e.v)throw Error("attempted to call addInitializer after decoration was finished")}(t),o(r,"An initializer"),e.push(r)}}function r(e,t){if(!e(t))throw new TypeError("Attempted to access private element on non-instance")}function n(e,n,o,i,a,s,l,d,u){var p;switch(a){case 1:p="accessor";break;case 2:p="method";break;case 3:p="getter";break;case 4:p="setter";break;default:p="field"}var f,g,h={kind:p,name:l?"#"+n:c(n),static:s,private:l},m={v:!1};if(0!==a&&(h.addInitializer=t(i,m)),l||0!==a&&2!==a)if(2===a)f=function(e){return r(u,e),o.value};else{var y=0===a||1===a;(y||3===a)&&(f=l?function(e){return r(u,e),o.get.call(e)}:function(e){return o.get.call(e)}),(y||4===a)&&(g=l?function(e,t){r(u,e),o.set.call(e,t)}:function(e,t){o.set.call(e,t)})}else f=function(e){return e[n]},0===a&&(g=function(e,t){e[n]=t});var v=l?u.bind():function(e){return n in e};h.access=f&&g?{get:f,set:g,has:v}:f?{get:f,has:v}:{set:g,has:v};try{return e(d,h)}finally{m.v=!0}}function o(e,t){if("function"!=typeof e)throw new TypeError(t+" must be a function")}function i(e,t){var r=typeof t;if(1===e){if("object"!==r||null===t)throw new TypeError("accessor decorators must return an object with get, set, or init properties or void 0");void 0!==t.get&&o(t.get,"accessor.get"),void 0!==t.set&&o(t.set,"accessor.set"),void 0!==t.init&&o(t.init,"accessor.init")}else if("function"!==r)throw new TypeError((0===e?"field":10===e?"class":"method")+" decorators must return a function or void 0")}function s(e){return function(t){e(this,t)}}function l(e,t,r,o,c,l,d,u,p){var f,g,h,m,y,v,N,b,w=r[0];if(d?(0===c||1===c?(f={get:(y=r[3],function(){return y(this)}),set:s(r[4])},h="get"):3===c?(f={get:r[3]},h="get"):4===c?(f={set:r[3]},h="set"):f={value:r[3]},0!==c&&(1===c&&a(f.set,"#"+o,"set"),a(f[h||"value"],"#"+o,h))):0!==c&&(f=Object.getOwnPropertyDescriptor(t,o)),1===c?m={get:f.get,set:f.set}:2===c?m=f.value:3===c?m=f.get:4===c&&(m=f.set),"function"==typeof w)void 0!==(v=n(w,o,f,u,c,l,d,m,p))&&(i(c,v),0===c?g=v:1===c?(g=v.init,N=v.get||m.get,b=v.set||m.set,m={get:N,set:b}):m=v);else for(var E=w.length-1;E>=0;E--){var _;void 0!==(v=n(w[E],o,f,u,c,l,d,m,p))&&(i(c,v),0===c?_=v:1===c?(_=v.init,N=v.get||m.get,b=v.set||m.set,m={get:N,set:b}):m=v,void 0!==_&&(void 0===g?g=_:"function"==typeof g?g=[g,_]:g.push(_)))}if(0===c||1===c){if(void 0===g)g=function(e,t){return t};else if("function"!=typeof g){var T=g;g=function(e,t){for(var r=t,n=0;n<T.length;n++)r=T[n].call(e,r);return r}}else{var x=g;g=function(e,t){return x.call(e,t)}}e.push(g)}0!==c&&(1===c?(f.get=m.get,f.set=m.set):2===c?f.value=m:3===c?f.get=m:4===c&&(f.set=m),d?1===c?(e.push((function(e,t){return m.get.call(e,t)})),e.push((function(e,t){return m.set.call(e,t)}))):2===c?e.push(m):e.push((function(e,t){return m.call(e,t)})):Object.defineProperty(t,o,f))}function d(t,r,n){for(var o,i,a,s=[],c=new Map,d=new Map,p=0;p<r.length;p++){var f=r[p];if(Array.isArray(f)){var g,h,m=f[1],y=f[2],v=f.length>3,N=m>=5,b=n;if(N?(g=t,0!=(m-=5)&&(h=i=i||[]),v&&!a&&(a=function(r){return e(r)===t}),b=a):(g=t.prototype,0!==m&&(h=o=o||[])),0!==m&&!v){var w=N?d:c,E=w.get(y)||0;if(!0===E||3===E&&4!==m||4===E&&3!==m)throw Error("Attempted to decorate a public method/accessor that has the same name as a previously decorated public method/accessor. This is not currently supported by the decorators plugin. Property name was: "+y);!E&&m>2?w.set(y,m):w.set(y,!0)}l(s,g,f,y,m,N,v,h,b)}}return u(s,o),u(s,i),s}function u(e,t){t&&e.push((function(e){for(var r=0;r<t.length;r++)t[r].call(e);return e}))}return function(e,r,n,o){return{e:d(e,r,o),get c(){return function(e,r){if(r.length>0){for(var n=[],o=e,a=e.name,s=r.length-1;s>=0;s--){var c={v:!1};try{var l=r[s](o,{kind:"class",name:a,addInitializer:t(n,c)})}finally{c.v=!0}void 0!==l&&(i(10,l),o=l)}return[o,function(){for(var e=0;e<n.length;e++)n[e].call(o)}]}}(e,n)}}}}function d(e,t,r,n){return(d=l())(e,t,r,n)}const u=Symbol("Events"),p=Symbol("allEvents"),f=/^on(?:Before|After)Action_/,g=/^onLocal_/,h=/^onAll_/;function m(e,t,r){const n=this;return e.has(t)||e.set(t,[]),e.get(t).push(r.bind(n)),n}const y=function e(t,r){let{kind:n}=r;if("class"==n)return class e extends t{constructor(e,t){const r={},n=[];for(const[e,o]of Object.entries(t))e.match(f)?n.push([e.substring(2),o,"onLocal"]):e.match(g)?n.push([e.substring(8),o,"onLocal"]):e.match(h)?n.push([e.substring(6),o,"onAll"]):r[e]=o;for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];super(e,r,...i);const s=this,c=Object.is(s,s.root);s[u]=new Map,c&&(s.root[p]=new Map),s.onLocal=m.bind(s,s[u]),s.onAll=m.bind(s.root,s.root[p]),s.on=s.onLocal;for(const[e,t,r]of n)s[r](e,t)}async emit(e,t){const r=this,n=[...r[u].get(e)||[],...r.root[p].get(e)||[]];let o=!1;if(n.length){let e=!1;t.preventDefault=()=>o=!0,t.stopPropagation=()=>e=!0;for(const r of n){if(e)break;await r(t)}}return!o}}};var v={disEnhance(e){e.targetNode.tagName.toLowerCase()&&e.targetNode.addEventListener("submit",(function(e){e.preventDefault()}))}};const N=["property_name"];var b;let w;const E={},_=Symbol("smart_component"),T=/^[a-z0-9_]+$/i,x=/[\*\?]/,A=e=>new RegExp("^"+e.replace(/\*+/g,".*").replace(/\?/g,".")+"$"),O=class e extends Error{constructor(e,t,r){super("RenderError(".concat(r,"): ").concat(t)),this.code=e,this.path=r,this.stack=this.stack.split("\n").slice(2).join("\n")}};function I(e,t){switch(e.tagName.toLowerCase()){case"ul":case"ol":case"table":case"thead":case"tbody":case"tfoot":return"list";case"input":const r=String(e.getAttribute("type")||"").toLowerCase();if(t.isSingleton)return t.options.type;switch(r){case"number":case"date":case"radio":case"color":return r}case"textarea":case"select":return"input";case"label":return"label";default:return"form"}}let S;class k{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{property_name:r="smark"}=t,n=o(t,N),i=arguments.length>2?arguments[2]:void 0;const a=this;if(a.validName=function e(){let t=0;return function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];for(let e of r)if("string"==typeof e&&(e=e.trim(),e.length))return e;return"UNNAMED"+ ++t}}(),a.actions={},a.property_name=r,a.selector="[data-".concat(a.property_name,"]"),a.types=E,a.targetNode=e,a.options=n,a.setNodeOptions(a.targetNode,a.options),a.parent=i,!a.parent instanceof S)throw a.renderError("INVALID_PARENT","Smark Components must have valid Smark Component parent.");a.root=null===a.parent?a:a.parent.root,a.parents={},a.parents[Symbol.iterator]=function*(){let e=a;for(;e;)yield e,e=e.parent};const s=a.inherittedOption("autoId",!1);let c;a.genId=!1!==s&&(!0===s?e=>e.replace(/\//g,"_"):"string"==typeof s?e=>s+e.replace(/\//g,"_"):"function"==typeof s&&s),a.onRenderedTasks=[],a.renderedSync=!1,a.rendered=new Promise((e=>c=e)),a.children={},a.targetNode[_]=a,(async()=>{await a.render();for(const e of a.onRenderedTasks)await e();a.onRenderedTasks=null,c(!0),setTimeout((()=>a.renderedSync=!0),1)})(),a.options.onRendered&&a.onRendered(a.options.onRendered)}onRendered(e){const t=this;t.onRenderedTasks?t.onRenderedTasks.push(e.bind(t)):e.bind(t)()}getNodeOptions(e,t){const r=this,o=(e.dataset[r.property_name]||"").trim()||null,i=n(n({},t),(()=>{try{const e=JSON.parse(o);if("object"!=typeof e)throw new Error("NO_OBJECT");return e}catch(e){return o.match(T)?{type:o}:{}}})());return i.action||i.type||(i.type=I(e,r)),r.setNodeOptions(e,i),i}setNodeOptions(e,t){const r=this;e.dataset[r.property_name]=JSON.stringify(t)}async enhance(e,t){const r=this;let n=r.getNodeOptions(e,t);if(v.disEnhance(r),n.action){if(n.type||(n.type="trigger"),"trigger"!=n.type)throw r.renderError("ACTION_IN_NON_TRIGGER",'"action" property is only allowed for "trigger" components but "'.concat(n.type,'" type specified.'))}else if("string"!=typeof n.type)throw r.renderError("NO_TYPE_PROVIDED","Invalid SmarkForm item: type is mandatory for non trigger components.");const o=r.types[n.type];if(!o)throw r.renderError("UNKNOWN_TYPE","Unimplemented SmarkForm component controller: ".concat(n.type));return new o(e,n,r)}getComponent(e){var t;const r=this;return e[_]||(null===(t=e.parentElement)||void 0===t?void 0:t.closest(r.selector)[_])||null}getPath(){const e=undefined;return[...this.parents].map((e=>e.name)).reverse().join("/")||"/"}find(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=this;if("/"==e[0])for(;t.parent;)t=t.parent;const r=e.split("/").filter((e=>e)),n=r.findIndex((e=>e.match(x)));if(n>=0){const e=A(r[n]),o=r.slice(0,n).join("/"),i=r.slice(n+1).join("/"),a=t.find(o),s=undefined;return Object.entries(a.children).filter((t=>{let[r,n]=t;return n&&r.match(e)})).map((e=>{let[,t]=e;return t.find(i)})).flat(1/0)}return r.reduce(((e,t)=>void 0===e?null:".."==t?e.parent:e.children[t]),t)}inherittedOption(e,t){const r=this;for(const t of r.parents)if(void 0!==t.options[e])return t.options[e];return t}moveTo(){const e=this;e.targetNode.id||(e.targetNode.id=e.getPath()),document.location.hash=e.targetNode.id,window.history.pushState({},void 0,window.location.pathname)}getTriggers(){let e;const t=this,r=[],n=new Set([arguments.length>0&&void 0!==arguments[0]?arguments[0]:""].flat().map(String).filter((e=>e))),o=n.has("*");for(const e of[...t.root.targetNode.querySelectorAll(t.selector)].map((e=>e[_])).filter((e=>e))){const i=e.getTriggerArgs();i&&(Object.is(i.context,t)&&(o||n.has(i.action))&&r.push(e))}return r}updateId(){const e=this;if(!1===e.genId)return;const t=e.genId(e.getPath());if(e.targetNode.id!=t){e.targetNode.id=t;for(const t of Object.values(e.children))t.updateId()}return e.targetNode.id}focus(){const e=this;for(const t in e.children)return e.children[t].focus();e.targetFieldNode&&e.targetFieldNode.focus()}getTriggerArgs(){}renderError(e,t){const r=undefined;return new O(e,t,this.getPath())}}b=k,[S,w]=d(b,[],[y]).c,w();class L extends S{constructor(){if(super(...arguments),this._isField=!0,!Object.is(this,this.root)&&(this.name=this.validName(this.options.name,this.targetNode.getAttribute("name")),this.options.hasOwnProperty("value"))){if(null!==this.targetNode.getAttribute("value"))throw me.renderError("VALUE_CONFLICT",'Initial value specied both as "value" option and HTML "value" attribute.');this.targetNode.setAttribute("value",this.options.value)}}}function P(e,t){if(void 0!==E[e])throw new Error("Duplicate component type definition: ".concat(e));if(!(t.prototype instanceof S))throw new Error("Bad component type implementation for: ".concat(e));E[e]=t}class j{constructor(e){const t=this;t.form=e,t.revealed=null,t.form.targetNode.addEventListener("keydown",t.onKeydown.bind(t),!0),t.form.targetNode.addEventListener("keyup",t.onKeyup.bind(t),!0),t.form.targetNode.addEventListener("focusout",t.onFocusout.bind(t),!0),t.form.targetNode.addEventListener("focusin",t.onFocusin.bind(t),!0)}onKeydown(e){const t=this;if("Control"==e.key)t.reveal(e.target);else if(e.ctrlKey){const r=t.revealed.find((t=>t.options.hotkey==e.key));r&&(e.preventDefault(),e.stopPropagation(),r.targetNode.click())}}onKeyup(e){const t=this;"Control"==e.key&&t.reveal(!1)}onFocusout(e){const t=this;null!==t.revealed&&t.reveal()}onFocusin(e){const t=this;null!==t.revealed&&t.reveal(e.target)}reveal(e){const t=this;if(null!==t.revealed){for(const e of t.revealed)e.targetNode.removeAttribute("data-hotkey");t.revealed.length=0}if(!1===e&&(t.revealed=null),e){const r=t.form.getComponent(e),n=[r,...r.parents],o=new Set(n),i=n.map(((e,t)=>e.getTriggers("*").map((e=>({tg:e,lv:t,args:e.getTriggerArgs()||{},hotkey:String(e.options.hotkey||"")}))))).flat().filter((e=>{let{args:t,hotkey:r}=e;return r.length&&o.has(t.context)})).sort(((e,t)=>o.has(t.args.target)-o.has(e.args.target)-t.lv+e.lv)),a=new Set;t.revealed=[];for(const e of i)a.has(e.hotkey)||(e.tg.targetNode.disabled||e.tg.targetNode.setAttribute("data-hotkey",e.hotkey),a.add(e.hotkey),t.revealed.push(e.tg))}}}const C=["action","context","target"],D=Symbol("beforeEventName"),F=Symbol("afterEventName"),R=function e(t,r){let{kind:n,name:o,addInitializer:i}=r;"method"==n&&i((function e(){this.actions[o]=t.bind(this),this.actions[o][D]="BeforeAction_".concat(o),this.actions[o][F]="AfterAction_".concat(o)}))};class M extends S{constructor(e,t){delete t.name;for(var r=arguments.length,n=new Array(r>2?r-2:0),o=2;o<r;o++)n[o-2]=arguments[o];return super(e,t,...n)}render(){const e=this;e.parent.onRendered((()=>{var t;const r=e.getTriggerArgs();"function"==typeof(null===(t=r.context)||void 0===t?void 0:t.onTriggerRender)&&r.context.onTriggerRender(r)}))}disable(){const e=undefined;this.targetNode.disabled=!0}enable(){const e=undefined;this.targetNode.disabled=!1}getTriggerArgs(){const e=this,t=[...e.parents],r=e.options,{action:i,context:a,target:s}=r,c=o(r,C);if(!i)return;let[l,d]=i.split(":").reverse();const u=a?e.parent.find(a):t.find((e=>(!d||e.options.type==d)&&"function"==typeof e.actions[l])),p=s?u.find(s):a?null:t.find((e=>{var t;return null===(t=e.parent)||void 0===t?void 0:t.targetNode.isSameNode(null==u?void 0:u.targetNode)}));return n({action:l,origin:e,context:u,target:p},c)}}async function U(e){const t=this,r=undefined,o=t.getComponent(e.target).getTriggerArgs();if(!o)return;const{context:i,action:a}=o,s=null==i?void 0:i.actions[a];if("function"!=typeof s)throw t.renderError("UNKNOWN_ACTION","Unknown action ".concat(a)+(i?" for ".concat(i.options.type):""));if(await t.emit(s[D],o)){const e=await s(o);t.emit(s[F],n(n({},o),{},{data:e}))}}function B(e,t){const r=undefined,n=null===e.parentNode?e=>null===e:t=>null===t||t.isSameNode(e);return[...e.querySelectorAll(t)].filter((e=>n(e.parentNode.closest(t))))}function H(e,t){let r=e.parentNode;const n=t>=0?1:-1;for(;r;){if(r.scrollHeight>r.clientHeight*n){var o=r.scrollHeight-r.clientHeight*n;if(t<=o*n)return void(r.scrollTop+=t);r.scrollTop=o,t-=o}r=r.parentNode}}function q(){return Math.random().toString(36).substring(2)}function K(e){try{return JSON.parse(e)}catch(e){}}const z=["context","target"];class G extends S{constructor(e,t){delete t.name;for(var r=arguments.length,n=new Array(r>2?r-2:0),o=2;o<r;o++)n[o-2]=arguments[o];return super(e,t,...n)}render(){const e=this;e.parent.onRendered((()=>{const t=e.getLabelArgs(),{targetFieldNode:r}=t.target||{};r&&(r.id||(r.id=q()),e.targetNode.setAttribute("for",r.id))}))}getLabelArgs(){const e=this;let t,r;e.parents;const i=e.options,{context:a,target:s}=i,c=o(i,z);if(a||s)t=a?e.parent.find(a):e.parent,r=s?t.find(s):t;else{t=e.parent;const n=t.targetNode.querySelectorAll(e.selector);let o=!1;for(const t in n)if(o){let o=e.getComponent(n[t]);if(null!=o&&o._isField){r=o;break}}else Object.is(n[t],e.targetNode)&&(o=!0)}return n({origin:e,context:t,target:r},c)}}const J=function e(t,r){let{kind:n}=r;if("class"==n){var o;let e;return o=class r extends t{constructor(){super(...arguments),e(this)}render(){const e=super.render(...arguments),t=this;return t.root.onRendered((()=>{t.fold({operation:t.options.folded?"fold":"unfold"})})),e}fold(){let{operation:e="toggle"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this,r="none"==t.targetNode.style.display,n="fold"==e||"unfold"!=e&&!r;t.targetNode.style.display=n?"none":t.originalDisplayProp,t.getTriggers("fold").forEach((e=>{const{foldedClass:t,unfoldedClass:r}=e.options;t&&e.targetNode.classList[n?"add":"remove"](t),r&&e.targetNode.classList[n?"remove":"add"](r)})),t.getTriggers(["addItem","removeItem"]).map(n?e=>e.disable():e=>e.enable())}},[e]=d(o,[[R,2,"fold"]],[]).e,o}};var W;let V,Y,$;class X extends L{constructor(){super(...arguments),V(this)}async render(){const e=this;e.originalDisplayProp=e.targetNode.style.display;for(const t of B(e.targetNode,e.selector)){const r=await e.enhance(t);if(null!=r&&r._isField){if(void 0!==e.children[r.name])throw e.renderError("REPEATED_FIELD_NAME","Field name '".concat(r.name,"' used more than once in this form level."));e.children[r.name]=r,r.updateId()}}}async export(){const e=this;return Object.fromEntries(await Promise.all(Object.entries(e.children).map((async e=>{let[t,r]=e;return[t,await r.export()]}))))}async import(){let{data:e={},focus:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this,n=Object(e).constructor;if(n!=={}.constructor)throw r.renderError("FORM_NOT_PLAIN_OBJECT","Expected plain object for form import, ".concat(n.name," given."));const o=Object.fromEntries(await Promise.all(Object.entries(r.children).map((async r=>{let[n,o]=r;const i=undefined;return[n,await o.import({data:e[n],focus:t})]}))));return t&&r.focus(),o}async isEmpty(){const e=this;for(const t of Object.values(e.children))if(!await t.isEmpty())return!1;return!0}async clear(){let{focus:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this;return await t.import({data:{},focus:e})}}W=X,({e:[V],c:[$,Y]}=d(W,[[R,2,"export"],[R,2,"import"],[R,2,"clear"]],[J])),Y();const Q=Symbol("smart_mutex");class Z{constructor(){this.mtx=Promise.resolve()}lock(){let e;const t=new Promise((t=>{e=()=>t()})),r=this.mtx;return this.mtx=t,r.then((function t(){return e}))}}const ee=function e(t){return function e(r,n){let{kind:o}=n;if("method"==o)return async function e(){const n=this;n[Q]||(n[Q]={}),n[Q][t]||(n[Q][t]=new Z);const o=await n[Q][t].lock();let i,a;try{for(var s=arguments.length,c=new Array(s),l=0;l<s;l++)c[l]=arguments[l];a=await r.call(n,...c)}catch(e){i=e}if(o(),i)throw i;return a}}},te=function e(t,r){let{kind:n}=r;if("class"==n){var o;let e,r,n;return r=ee("list_mutating"),n="render",o=class r extends t{constructor(){super(...arguments),e(this)}async[n](){const e=await super.render(...arguments),t=this;if(t.sortable=!!t.options.sortable,t.templates.item.setAttribute("draggable",t.sortable),t.children.forEach((e=>e.targetNode.setAttribute("dragable",t.sortable))),t.sortable){let e=null,r=null;t.targetNode.addEventListener("dragstart",(t=>{null===e?(e=t.target,t.stopPropagation()):t.preventDefault()})),t.targetNode.addEventListener("dragover",(e=>e.preventDefault())),t.targetNode.addEventListener("drop",(t=>{if(!e)return;let n=t.target;for(;n.parentElement&&n.parentElement!=e.parentElement;)n=n.parentElement;r=n})),t.targetNode.addEventListener("dragend",(async()=>{r&&await t.move({from:t.getComponent(e),to:t.getComponent(r)}),e=null,r=null}))}return e}async move(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this;let{from:r,to:n}=e;if(null===n||null===r)return;const o=Number(null==r?void 0:r.name),i=Number(null==n?void 0:n.name);if(o==i)return;if(o<i){const e=[...t.children.slice(o+1,i+1),t.children[o]];t.children.splice(o,i-o+1,...e)}else if(o>i){const e=[t.children[o],...t.children.slice(i,o)];t.children.splice(i,o-i+1,...e)}const a=undefined,s=(o<i?1:-1)>0?"after":"before";n.targetNode[s](r.targetNode),t.renum()}},[e]=d(o,[[r,2,"move"]],[]).e,o}};async function re(e){await e.rendered;for(const t of e.getTriggers(["removeItem","addItem"]))t.targetNode.disabled="removeItem"==t.options.action?e.children.length<=e.min_items&&"clear"!=t.options.failback:e.children.length>=e.max_items}const ne=function e(t,r){let{kind:n}=r;return"class"==n?class e extends t{async render(){const e=await super.render(...arguments),t=this;return setTimeout((()=>re(t)),1),e}}:"method"==n?async function e(){const r=this;for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];const a=await t.call(r,...o);return re(r),a}:void 0},oe=["action","origin","context"];var ie;let ae,se,ce,le,de,ue,pe;function fe(e){null===e.getAttribute("tabindex")&&e.setAttribute("tabindex","-1")}ce=[ee("list_mutating"),R],le=[R,ee("list_mutating"),ne],de=[R,ee("list_mutating"),ne],ue="render";class ge extends L{constructor(){super(...arguments),ae(this)}async[ue](){const e=this;e.originalDisplayProp=e.targetNode.style.display,e.min_items=Math.max(0,"number"==typeof e.options.min_items?e.options.min_items:1),e.max_items=Math.max(e.min_items,"number"==typeof e.options.max_items?e.options.max_items:1/0),e.children=[],e.templates={};for(const t of[...e.targetNode.children]){const{role:r="item"}=K(t.getAttribute("data-smark"))||{};switch(r){case"empty_list":case"separator":case"last_separator":t.setAttribute("data-role",r);case"item":if(void 0!==e.templates[r])throw e.renderError("LIST_DUPLICATE_TEMPLATE","Repated list template role ".concat(r));e.templates[r]=t,e.templates[r].remove()}}if(e.templates.last_separator||(e.templates.last_separator=e.templates.separator),e.targetNode.children.length){const{role:t="item"}=K(e.targetNode.children[0].getAttribute("data-smark"))||{};throw e.renderError("LIST_UNKNOWN_TEMPLATE_ROLE","Unknown list template role ".concat(t))}if(null!==e.templates.item.querySelector("[id]"))throw e.renderError("LIST_CONTAINS_ID","List components are not allowed to contain elements with 'id' attribute");const t=e.getNodeOptions(e.templates.item,{type:e.options.of});if(e.options.of&&t.type!=e.options.of)throw e.renderError("LIST_ITEM_TYPE_MISSMATCH","List item type missmatch");e.root.onRendered((async()=>{for(let t=0;t<e.min_items;t++)await e.addItem();0==e.min_items&&e.renum(),e.targetNode.setAttribute("aria-live","polite"),e.targetNode.setAttribute("aria-atomic","true")}))}onTriggerRender(e){let{action:t,origin:r,context:n}=e;switch(o(e,oe),t){case"addItem":case"removeItem":1+[...r.parents].findIndex((e=>Object.is(e,n)))&&r.options.hotkey&&fe(r.targetNode)}}async export(){const e=this,t=[],r=[],n=!e.inherittedOption("exportEmpties",!1);for(const o of e.children)n&&await o.isEmpty()?t.length<e.min_items&&r.push(o):t.push(await o.export());for(let n=0;t.length<e.min_items;n++)t.push(await r[n].export());return t}async import(){let{data:e=[],focus:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this;e instanceof Array||(e=[e]);for(let n=0;n<Math.min(e.length,r.max_items);n++)r.children.length<=n&&await r.addItem(),await r.children[n].import({data:e[n],focus:t});for(let t=Math.max(e.length,r.min_items);t<r.children.length;)await r.removeItem();e.length>r.max_items&&r.emit("error",{code:"LIST_IMPORT_OVERFLOW",message:"Trying to import array greater than list's max_items. Data beyond max_items ignored.",context:r,data:e,options:r.options});for(let t=e.length;t<r.children.length;t++)r.children[t].clear();t&&r.focus()}async addItem(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this;let{action:r,origin:n=null,context:o=t,target:i,position:a="after",autoscroll:s,failback:c}=e;if("after"!=a&&"before"!=a)throw t.renderError("LIST_WRONG_ADDITEM_POSITION","Invalid value for addItem() position property: ".concat(a));if(t.children.length>=t.max_items){if("none"===c);else t.emit("error",{code:"LIST_MAX_ITEMS_REACHED",message:"Cannot add items over max_items boundary",options:e});return}t.children.length&&!i&&(i="before"==a?t.children[0]:t.children[t.children.length-1]);const l=t.templates.item.cloneNode(!0),d=[];let u;if(await t.emit("addItem",{action:r,origin:n,context:o,target:i,position:a,newItemTarget:l,options:e,onRendered:e=>d.push(e)}),t.children.length?t.children=(await Promise.all(t.children.map((async(e,r)=>e.targetNode.isSameNode(i.targetNode)?"after"==a?(e.targetNode.after(l),u=await t.enhance(l,{type:"form"}),await u.rendered,[e,u]):(e.targetNode.before(l),u=await t.enhance(l,{type:"form"}),await u.rendered,[u,e]):e)))).flat():(t.targetNode.appendChild(l),u=await t.enhance(l,{type:"form",name:0}),await u.rendered,t.children.push(u),u.name=0),t.renum(),"elegant"==s&&u)H(u.targetNode,-u.offsetHeight);else{const e=u?"self"==s?u:"parent"==s?u.parent:null:null;e&&e.moveTo()}d.forEach((e=>e(u))),t.renderedSync&&u.focus()}async removeItem(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this;let{action:r,origin:n=null,context:o=t,target:i,autoscroll:a,keep_non_empty:s,failback:c}=e;if(!i){if(s)for(const e of[...t.children].reverse())if(await e.isEmpty()){i=e;break}i||(i=t.children[t.children.length-1],s=!1)}const l=i instanceof Array?i:[i];for(const i of[...l].reverse()){if(t.children.length<=t.min_items)switch(c){case"none":break;case"clear":return void await i.clear();default:return void t.emit("error",{code:"LIST_MIN_ITEMS_REACHED",message:"Cannot remove items under min_items boundary",options:e})}if(s&&!await i.isEmpty())continue;let l=null,d=null;const u=t.children.filter(((e,t,r)=>{if(e.targetNode.isSameNode(i.targetNode)){if("elegant"==a)H(e.targetNode,e.targetNode.offsetHeight);else{const t="self"==a?e:"parent"==a?e.parent:null;t&&t.moveTo()}return l=e,d=r.length-t>1?d=t:0==t?null:t-1,!1}return!0})),p=[];await t.emit("removeItem",{action:r,origin:n,context:o,target:i,oldItem:l,oldItemTarget:l.targetNode,options:e,onRemoved:e=>p.push(e)}),l.targetNode.remove(),t.children=u,t.renum(),p.forEach((e=>e())),null!==d&&t.children[d].focus()}}async isEmpty(){const e=this;for(const t of e.children)if(!await t.isEmpty())return!1;return!0}async clear(){let{focus:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this;return await t.import({data:[],focus:e})}count(){let{delta:e=0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=undefined;return this.children.length+Number(e)}position(){let{target:e,offset:t=1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Number(null==e?void 0:e.name)+Number(t)}renum(){const e=this;for(const t in e.children)e.children[t].name=t,e.children[t].updateId();if(e.templates.separator||e.templates.last_separator)for(const t in e.children){const r=t>=e.children.length-1,n=t<=0?null:r?"last_separator":"separator",o=e.children[t].targetNode,i=o.previousElementSibling,a=i&&i.getAttribute("data-role");if(a!==n){a&&i.remove();const t=e.templates[n];n&&t&&o.parentElement.insertBefore(t.cloneNode(!0),o)}if(r){const e=o.nextElementSibling;e&&e.remove()}}e.templates.empty_list&&(e.children.length?e.templates.empty_list.remove():e.targetNode.appendChild(e.templates.empty_list)),e.getTriggers("position").forEach((e=>{const t=this,r=e.getTriggerArgs();e.targetNode.innerText=t.position(r)})),e.getTriggers("count").forEach((e=>{const t=this,r=e.getTriggerArgs();e.targetNode.innerText=t.count(r)}))}}var he;let ye;ie=ge,({e:[ae],c:[pe,se]}=d(ie,[[ce,2,"export"],[R,2,"import"],[le,2,"addItem"],[de,2,"removeItem"],[R,2,"clear"],[R,2,"count"],[R,2,"position"]],[J,te,ne])),se();class ve extends ${constructor(){super(...arguments),ye(this)}async render(){const e=this;if(e.isSingleton=!("INPUT"===e.targetNode.tagName||"SELECT"===e.targetNode.tagName||"TEXTAREA"===e.targetNode.tagName),e.isCheckbox=!e.isSingleton&&"checkbox"==String(e.targetNode.type).toLowerCase(),e.isSingleton){await super.render();const t=Object.values(e.children);if(1!=t.length)throw e.renderError("NOT_A_SINGLETON","Singleton forms are only allowed to contain exactly one"+" data field but ".concat(t.length," found."));const r=t[0];if(e.options.type!==r.options.type)throw e.renderError("SINGLETON_TYPE_MISMATCH","Singleton type (".concat(e.options.type,")")+" does not match child field type (".concat(r.options.type,")."));e.targetFieldNode=r.targetNode}else e.targetFieldNode=e.targetNode}async export(){const e=this;return e.isSingleton?Object.values(await super.export())[0]:e.isCheckbox?!!e.targetNode.checked:e.targetNode.value}async import(){let{data:e="",focus:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this;return r.isSingleton?await super.import({data:Object.fromEntries([[Object.keys(r.children)[0],e]]),focus:t}):(r.isCheckbox?r.targetNode.checked=!!e:r.targetNode.value=e,t&&r.focus(),r.targetNode.value)}async isEmpty(){const e=this,t=undefined;return!(e.isCheckbox?"":await e.export()).trim().length}async clear(){let{focus:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this;await t.import({focus:e})}}var Ne;let be;he=ve,[ye]=d(he,[[R,2,"export"],[R,2,"import"],[R,2,"clear"]],[]).e;class we extends ve{constructor(){super(...arguments),be(this)}async render(){await super.render();const e=this,t=e.targetFieldNode.tagName,r=e.targetFieldNode.getAttribute("type");if("INPUT"!=t||"number"!=(r||"number").toLowerCase())throw e.renderError("NOT_A_NUMBER_FIELD",'Number inputs require an INPUT tag of type "number".');r||(e.targetFieldNode.type="number")}async export(){const e=this,t=await super.export();return e.isSingleton?t:t.length&&!isNaN(t)?Number(t):null}async import(){let{data:e=null,focus:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=undefined,n=typeof e;if(this.isSingleton)return await super.import({data:e,focus:t});const o=undefined;return await super.import({data:"number"==n?e:"string"==n&&e.length&&!isNaN(e)?Number(e):null,focus:t})}async isEmpty(){const e=this,t=undefined;return null===await e.export()}}var Ee;let _e;Ne=we,[be]=d(Ne,[[R,2,"export"],[R,2,"import"]],[]).e;const Te=/T.*/;function xe(e){return 8==e.length?new Date([e.substring(0,4),e.substring(4,6),e.substring(6,8)].join("-")):10==e.length&&"-"==e[4]&&"-"==e[7]?new Date(e):NaN}function Ae(e){return e.toISOString().replace(Te,"")}class Oe extends ve{constructor(){super(...arguments),_e(this)}async render(){await super.render();const e=this,t=e.targetFieldNode.tagName,r=e.targetFieldNode.getAttribute("type");if("INPUT"!=t||"date"!=(r||"date").toLowerCase())throw e.renderError("NOT_A_DATE_FIELD",'Date inputs require an INPUT tag of type "date".');r||(e.targetFieldNode.type="date")}async export(){const e=this,t=await super.export();if(e.isSingleton)return t;if(!t.length)return null;const r=xe(t);return isNaN(r)?null:Ae(r)}async import(){let{data:e=null,focus:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=undefined;if(this.isSingleton)return await super.import({data:e,focus:t});const n=e instanceof Date?e:"number"==typeof e?new Date(e):e&&"string"==typeof e?xe(e):NaN,o=undefined;return await super.import({data:isNaN(n)?null:Ae(n),focus:t})}async isEmpty(){const e=this,t=undefined;return null===await e.export()}}var Ie;let Se;Ee=Oe,[_e]=d(Ee,[[R,2,"export"],[R,2,"import"]],[]).e;class ke extends ve{constructor(){Se(super(...arguments));const e=this,t=e.parent.children[e.name];return t?(e.targetNode.setAttribute("name",t.sharedNodeName),t.radioButtons.push(e.targetNode),{}):(e.sharedNodeName=q(),e.targetNode.setAttribute("name",e.sharedNodeName),e.radioButtons=[e.targetNode],e)}async render(){await super.render();const e=this,t=e.targetFieldNode.tagName,r=e.targetFieldNode.getAttribute("type");if("INPUT"!=t||"radio"!=(r||"radio").toLowerCase())throw e.renderError("NOT_A_RADIO_FIELD",'Radio inputs require an INPUT tag of type "radio".');r||(e.targetFieldNode.type="radio")}async export(){var e;return null===(e=this.radioButtons.find((e=>e.checked)))||void 0===e?void 0:e.value}async import(){let{data:e=null,focus:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this.radioButtons.find((t=>t.value===e));r&&(r.checked=!0),t&&this.focus()}async isEmpty(){return!(1+this.radioButtons.findIndex((e=>e.checked)))}}var Le;let Pe;Ie=ke,[Se]=d(Ie,[[R,2,"export"],[R,2,"import"]],[]).e;const je=/^#([a-f0-9]{3}){1,2}$/i,Ce="\n    opacity: .5;\n    background: repeating-linear-gradient(\n            45deg,\n            black,\n            black 10px,\n            white 10px,\n            white 20px\n        ),\n        black;\n    background-blend-mode: difference;\n";class De extends ve{constructor(){super(...arguments),Pe(this)}async render(){await super.render();const e=this;if(e.isSingleton)return;const t=e.targetFieldNode.tagName,r=e.targetFieldNode.getAttribute("type");if("INPUT"!=t||"color"!=(r||"color").toLowerCase())throw e.renderError("NOT_A_COLOR_FIELD",'Color inputs require an INPUT tag of type "color".');r||(e.targetFieldNode.type="color");const n=e.targetFieldNode.getAttribute("value");e.isDefined=null!==n&&""!==n.trim(),e.defaultStyleAttr=e.targetFieldNode.getAttribute("style")+";",e.isDefined||e.targetFieldNode.setAttribute("style",e.defaultStyleAttr+Ce);const o=t=>{"Enter"!==t.code&&"Space"!==t.Code&&void 0!==t.code||(e.isDefined=!0,e.targetFieldNode.setAttribute("style",e.defaultStyleAttr))};e.targetFieldNode.addEventListener("keydown",o),e.targetFieldNode.addEventListener("click",o),e.targetFieldNode.addEventListener("change",o)}async export(){const e=this;let t=await super.export();return e.isSingleton||(t=e.isDefined&&t.match(je)?t.toLowerCase():null),t}async import(){let{data:e=null,focus:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this;r.isSingleton||null!==e||(r.isDefined=!1,r.targetFieldNode.setAttribute("style",r.defaultStyleAttr+Ce));const n=await super.import({data:e,focus:t});return r.isDefined?n:null}async isEmpty(){const e=this,t=undefined;return null===await e.export()}}Le=De,[Pe]=d(Le,[[R,2,"export"],[R,2,"import"]],[]).e;const Fe=["customActions"];for(const[e,t]of Object.entries({trigger:M,label:G,form:$,list:pe,input:ve,number:we,date:Oe,radio:ke,color:De}))P(e,t);class Re extends ${constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{customActions:r={}}=t,i;const a=n(n({},o(t,Fe)),{},{name:"",type:"form"});super(e,a,null);const s=this;s.setNodeOptions(s.targetNode,a),s.actions=n(n({},s.actions),Object.fromEntries(Object.entries(r).map((e=>{let[t,r]=e;return[t,r.bind(s)]})))),s.targetNode.addEventListener("click",U.bind(s),!0),new j(s)}async render(){const e=this;e.targetNode.setAttribute("aria-busy","true"),await super.render(),e.targetNode.setAttribute("aria-busy","false")}}return Re.createType=P,Re}));//# sourceMappingURL=SmarkForm.umd.js.map
