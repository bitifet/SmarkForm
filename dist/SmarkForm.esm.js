function e(e){if(Object(e)!==e)throw TypeError("right-hand side of 'in' should be an object, got "+(null!==e?typeof e:"null"));return e}function t(e,t,r){"symbol"==typeof t&&(t=(t=t.description)?"["+t+"]":"");try{Object.defineProperty(e,"name",{configurable:!0,value:r?r+" "+t:t})}catch(e){}return e}function r(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function n(o,i,a,s){return(n=function(){function n(e,t){return function(r){!function(e){if(e.v)throw Error("attempted to call addInitializer after decoration was finished")}(t),a(r,"An initializer"),e.push(r)}}function o(e,t){if(!e(t))throw new TypeError("Attempted to access private element on non-instance")}function i(e,t,i,a,s,l,c,d,u){var p;switch(s){case 1:p="accessor";break;case 2:p="method";break;case 3:p="getter";break;case 4:p="setter";break;default:p="field"}var g,f,h={kind:p,name:c?"#"+t:r(t),static:l,private:c},m={v:!1};if(0!==s&&(h.addInitializer=n(a,m)),c||0!==s&&2!==s)if(2===s)g=function(e){return o(u,e),i.value};else{var y=0===s||1===s;(y||3===s)&&(g=c?function(e){return o(u,e),i.get.call(e)}:function(e){return i.get.call(e)}),(y||4===s)&&(f=c?function(e,t){o(u,e),i.set.call(e,t)}:function(e,t){i.set.call(e,t)})}else g=function(e){return e[t]},0===s&&(f=function(e,r){e[t]=r});var N=c?u.bind():function(e){return t in e};h.access=g&&f?{get:g,set:f,has:N}:g?{get:g,has:N}:{set:f,has:N};try{return e(d,h)}finally{m.v=!0}}function a(e,t){if("function"!=typeof e)throw new TypeError(t+" must be a function")}function s(e,t){var r=typeof t;if(1===e){if("object"!==r||null===t)throw new TypeError("accessor decorators must return an object with get, set, or init properties or void 0");void 0!==t.get&&a(t.get,"accessor.get"),void 0!==t.set&&a(t.set,"accessor.set"),void 0!==t.init&&a(t.init,"accessor.init")}else if("function"!==r)throw new TypeError((0===e?"field":10===e?"class":"method")+" decorators must return a function or void 0")}function l(e){return function(t){e(this,t)}}function c(e,r,n,o,a,c,d,u,p){var g,f,h,m,y,N,v,b,w=n[0];if(d?(0===a||1===a?(g={get:(y=n[3],function(){return y(this)}),set:l(n[4])},h="get"):3===a?(g={get:n[3]},h="get"):4===a?(g={set:n[3]},h="set"):g={value:n[3]},0!==a&&(1===a&&t(g.set,"#"+o,"set"),t(g[h||"value"],"#"+o,h))):0!==a&&(g=Object.getOwnPropertyDescriptor(r,o)),1===a?m={get:g.get,set:g.set}:2===a?m=g.value:3===a?m=g.get:4===a&&(m=g.set),"function"==typeof w)void 0!==(N=i(w,o,g,u,a,c,d,m,p))&&(s(a,N),0===a?f=N:1===a?(f=N.init,v=N.get||m.get,b=N.set||m.set,m={get:v,set:b}):m=N);else for(var E=w.length-1;E>=0;E--){var _;void 0!==(N=i(w[E],o,g,u,a,c,d,m,p))&&(s(a,N),0===a?_=N:1===a?(_=N.init,v=N.get||m.get,b=N.set||m.set,m={get:v,set:b}):m=N,void 0!==_&&(void 0===f?f=_:"function"==typeof f?f=[f,_]:f.push(_)))}if(0===a||1===a){if(void 0===f)f=function(e,t){return t};else if("function"!=typeof f){var x=f;f=function(e,t){for(var r=t,n=0;n<x.length;n++)r=x[n].call(e,r);return r}}else{var A=f;f=function(e,t){return A.call(e,t)}}e.push(f)}0!==a&&(1===a?(g.get=m.get,g.set=m.set):2===a?g.value=m:3===a?g.get=m:4===a&&(g.set=m),d?1===a?(e.push(function(e,t){return m.get.call(e,t)}),e.push(function(e,t){return m.set.call(e,t)})):2===a?e.push(m):e.push(function(e,t){return m.call(e,t)}):Object.defineProperty(r,o,g))}function d(t,r,n){for(var o,i,a,s=[],l=new Map,d=new Map,p=0;p<r.length;p++){var g=r[p];if(Array.isArray(g)){var f,h,m=g[1],y=g[2],N=g.length>3,v=m>=5,b=n;if(v?(f=t,0!=(m-=5)&&(h=i=i||[]),N&&!a&&(a=function(r){return e(r)===t}),b=a):(f=t.prototype,0!==m&&(h=o=o||[])),0!==m&&!N){var w=v?d:l,E=w.get(y)||0;if(!0===E||3===E&&4!==m||4===E&&3!==m)throw Error("Attempted to decorate a public method/accessor that has the same name as a previously decorated public method/accessor. This is not currently supported by the decorators plugin. Property name was: "+y);!E&&m>2?w.set(y,m):w.set(y,!0)}c(s,f,g,y,m,v,N,h,b)}}return u(s,o),u(s,i),s}function u(e,t){t&&e.push(function(e){for(var r=0;r<t.length;r++)t[r].call(e);return e})}return function(e,t,r,o){return{e:d(e,t,o),get c(){return function(e,t){if(t.length>0){for(var r=[],o=e,i=e.name,a=t.length-1;a>=0;a--){var l={v:!1};try{var c=t[a](o,{kind:"class",name:i,addInitializer:n(r,l)})}finally{l.v=!0}void 0!==c&&(s(10,c),o=c)}return[o,function(){for(var e=0;e<r.length;e++)r[e].call(o)}]}}(e,r)}}}}())(o,i,a,s)}function o(e,t){const r=null===e.parentNode?e=>null===e:t=>null===t||t.isSameNode(e);return[...e.querySelectorAll(t)].filter(e=>r(e.parentNode.closest(t)))}function i(e,t){let r=e.parentNode;const n=t>=0?1:-1;for(;r;){if(r.scrollHeight>r.clientHeight*n){var o=r.scrollHeight-r.clientHeight*n;if(t<=o*n)return void(r.scrollTop+=t);r.scrollTop=o,t-=o}r=r.parentNode}}function a(){return Math.random().toString(36).substring(2)}function s(e){try{return JSON.parse(e)}catch(e){}}const l=Symbol("Events"),c=Symbol("allEvents"),d=/^on(?:Before|After)Action_/,u=/^onLocal_/,p=/^onAll_/,g=["keydown","keyup","keypress","beforeinput","input","change","focus","blur","click","dblclick","contextmenu","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","focusin","focusout"];function f(e,t,r){return e.has(t)||e.set(t,[]),e.get(t).push(r.bind(this)),this}const h=function(e,t){let{kind:r}=t;if("class"==r)return class extends e{constructor(e,t){const r={},n=[];for(const[e,o]of Object.entries(t))e.match(d)?n.push([e.substring(2),o,"onLocal"]):e.match(u)?n.push([e.substring(8),o,"onLocal"]):e.match(p)?n.push([e.substring(6),o,"onAll"]):r[e]=o;for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];super(e,r,...i);const s=this;if(s[l]=new Map,s[c]=new Map,s.onLocal=f.bind(s,s[l]),s.onAll=f.bind(s,s[c]),s.on=s.onAll,s.eventHooks=function(e){const t={};for(const r in e)t[r]=[...e[r]];return Object.defineProperty(t,"_dynamic",{get(){return new Proxy(this,{get:(e,t)=>(t in e||(e[t]=[]),e[t])})}}),t._dynamic}(super.eventHooks),Object.is(s,s.root))for(const e of g)s.targetNode.addEventListener(e,t=>{const r=s.getComponent(t.target),n={type:e,originalEvent:t,context:r,preventDefault:t.preventDefault.bind(t),stopPropagation:t.stopPropagation.bind(t),stopImmediatePropagation:t.stopImmediatePropagation.bind(t)};r.emit(e,n)},!0);for(const[e,t,r]of n)s[r](e,t)}async emit(e,t){const r=this,n=[...r[l].get(e)||[],...r[c].get(e)||[]];for(const e of n)await e(t);for(const n of r.parents){const r=n[c].get(e)||[];for(const e of r)await e(t)}for(const n of r.eventHooks[e])await n(t);return!0}}};var m,y={disEnhance(e){e.targetNode.tagName.toLowerCase()&&e.targetNode.addEventListener("submit",function(e){e.preventDefault()})}};let N;const v={},b=Symbol("smart_component"),w=/^[a-z0-9_]+$/i,E=/[\*\?]/,_=class extends Error{constructor(e,t,r){super(`RenderError(${r}): ${t}`),this.code=e,this.path=r,this.stack=this.stack.split("\n").slice(2).join("\n")}};let x;class A{constructor(e){let{property_name:t="smark",...r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;const o=this;if(o.validName=function(){let e=0;return function(){if(o.parent.isSingleton)return"";for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];for(let e of r)if("string"==typeof e&&(e=e.trim(),e.length))return e;return"UNNAMED"+ ++e}}(),o.actions={},o.property_name=t,o.selector=`[data-${o.property_name}]`,o.types=v,o.targetNode=e,o.options=r,o.setNodeOptions(o.targetNode,o.options),o.parent=n,!o.parent instanceof x)throw o.renderError("INVALID_PARENT","Smark Components must have valid Smark Component parent.");o.root=null===o.parent?o:o.parent.root,o.parents={},o.parents[Symbol.iterator]=function*(){let e=o.parent;for(;e;)yield e,e=e.parent};const i=o.inherittedOption("autoId",!1);let a;o.genId=!1!==i&&(!0===i?e=>e.replace(/\//g,"_"):"string"==typeof i?e=>i+e.replace(/\//g,"_"):"function"==typeof i&&i),o.onRenderedTasks=[],o.renderedSync=!1,o.rendered=new Promise(e=>a=e),o.children={},o.targetNode[b]=o,(async()=>{await o.render();for(const e of o.onRenderedTasks)await e();o.onRenderedTasks=null,a(!0),setTimeout(()=>o.renderedSync=!0,1),await o.emit("afterRender",{context:o},!1)})(),o.options.onRendered&&o.onRendered(o.options.onRendered)}async unrender(){const e=this;await e.emit("beforeUnrender",{context:e},!1),e.targetNode.remove()}onRendered(e){const t=this;t.onRenderedTasks?t.onRenderedTasks.push(e.bind(t)):e.bind(t)()}getNodeOptions(e,t){const r=this,n=(e.dataset[r.property_name]||"").trim()||null,o={...t,...(()=>{try{const e=JSON.parse(n);if("object"!=typeof e)throw new Error("NO_OBJECT");return e}catch(e){return n.match(w)?{type:n}:{}}})()};return o.action||o.type||(o.type=function(e,t){switch(e.tagName.toLowerCase()){case"ul":case"ol":case"table":case"thead":case"tbody":case"tfoot":return"list";case"input":const r=String(e.getAttribute("type")||"").toLowerCase();if(t.isSingleton)return t.options.type;switch(r){case"number":case"date":case"radio":case"color":return r}case"textarea":case"select":return"input";case"label":return"label";default:return"form"}}(e,r)),r.setNodeOptions(e,o),o}setNodeOptions(e,t){e.dataset[this.property_name]=JSON.stringify(t)}async enhance(e,t){const r=this;let n=r.getNodeOptions(e,t);if(y.disEnhance(r),n.action){if(n.type||(n.type="trigger"),"trigger"!=n.type)throw r.renderError("ACTION_IN_NON_TRIGGER",`"action" property is only allowed for "trigger" components but "${n.type}" type specified.`)}else if("string"!=typeof n.type)throw r.renderError("NO_TYPE_PROVIDED","Invalid SmarkForm item: type is mandatory for non trigger components.");const o=r.types[n.type];if(!o)throw r.renderError("UNKNOWN_TYPE",`Unimplemented SmarkForm component controller: ${n.type}`);return new o(e,n,r)}getComponent(e){return e[b]||e.parentElement?.closest(this.selector)[b]||null}getPath(){const e=this;return[e,...e.parents].map(e=>e.name).reverse().join("/")||"/"}find(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";let t=this;if(""===t.name&&t.parent.isSingleton&&(t=t.parent),e=String(e),"/"==e[0])for(;t.parent;)t=t.parent;const r=e.split("/").filter(e=>e),n=r.findIndex(e=>e.match(E));if(n>=0){const e=(o=r[n],new RegExp("^"+o.replace(/\*+/g,".*").replace(/\?/g,".")+"$")),i=r.slice(0,n).join("/"),a=r.slice(n+1).join("/"),s=t.find(i);return Object.entries(s.children).filter(t=>{let[r,n]=t;return n&&r.match(e)}).map(e=>{let[,t]=e;return t.find(a)}).flat(1/0)}var o;return r.reduce((e,t)=>{if(void 0!==e){if(".."==t)return e.parent;if("."!=t[0])return e.children[t];{if("."==t)return e;if(!e.parent)return;const r=parseInt(t.slice(1));if(isNaN(r))return;if("list"!=e.parent.options.type){const t=Object.keys(e.parent.children),n=t.findIndex(t=>t==e.name),o=t[n+r];return e.parent.children[o]}{const t=parseInt(e.name)+r;if(!isNaN(t))return e.parent.children[t]}}}},t)}inherittedOption(e,t){const r=this;for(const t of[r,...r.parents])if(void 0!==t.options[e])return t.options[e];return t}moveTo(){const e=this;e.targetNode.id||(e.targetNode.id=e.getPath()),document.location.hash=e.targetNode.id,window.history.pushState({},void 0,window.location.pathname)}getTriggers(){const e=this,t=[],r=new Set([arguments.length>0&&void 0!==arguments[0]?arguments[0]:""].flat().map(String).filter(e=>e)),n=r.has("*");for(const o of[e,...e.root.targetNode.querySelectorAll(e.selector)].map(e=>e[b]).filter(e=>e)){const i=o.getTriggerArgs();i&&((Object.is(i.context,e)||Object.is(o,e))&&(n||r.has(i.action))&&t.push(o))}return t}updateId(){const e=this;if(!1===e.genId)return;const t=e.genId(e.getPath());if(e.targetNode.id!=t){e.targetNode.id=t;for(const t of Object.values(e.children))t.updateId()}return e.targetNode.id}focus(){const e=this;for(const t in e.children)return e.children[t].focus();e.targetFieldNode?e.targetFieldNode.focus():e.targetNode.focus()}getTriggerArgs(){}renderError(e,t){const r=this,n=r.parent?.isSingleton?r.parent.targetNode:r.targetNode,o=new _(e,t,r.getPath());return function(e,t){const r=document.createElement("div");r.setAttribute("title",t.message),r.setAttribute("style","display: inline-block; padding: .5em 1em; background: red; color: yellow; border-radius: 50% 0%"),r.appendChild(document.createTextNode(t.code));const n=document.createElement("span");n.setAttribute("title","Log the error again"),n.setAttribute("style","cursor: pointer; font-weight: bold; background-color: white; color: red; border-radius: 50%; padding: 0 4px; margin-left: 8px;"),n.textContent="↧",n.addEventListener("click",()=>{console.error(t)}),r.appendChild(n),e.replaceWith(r)}(n,o),o}static#e=(()=>m=()=>([x,N]=n(this,[],[h]).c,N()))()}m();class k extends x{constructor(){if(super(...arguments),this._isField=!0,!Object.is(this,this.root)&&(this.name=this.validName(this.options.name,this.targetNode.getAttribute("name")),this.options.hasOwnProperty("value"))){if(null!==this.targetNode.getAttribute("value"))throw me.renderError("VALUE_CONFLICT",'Initial value specied both as "value" option and HTML "value" attribute.');this.targetNode.setAttribute("value",this.options.value)}}}function T(e,t){if(void 0!==v[e])throw new Error(`Duplicate component type definition: ${e}`);if(!(t.prototype instanceof x))throw new Error(`Bad component type implementation for: ${e}`);v[e]=t}class I{constructor(e){const t=this;t.form=e,t.revealed=null;const r=I.onStatusChange.bind(t);t.form.targetNode.addEventListener("keydown",r,!0),t.form.targetNode.addEventListener("keyup",r,!0),t.form.targetNode.addEventListener("focusout",r,!0),t.form.targetNode.addEventListener("focusin",r,!0)}static onStatusChange(e){const t=this;if("keyup"==e.type)return void("Control"==e.key&&t.reveal(!1));if("focusout"==e.type)return void(null!==t.revealed&&t.reveal());if("focusin"==e.type&&null===t.revealed)return;const r=e.ctrlKey||"Control"==e.key,n=e.altKey||"Alt"==e.key;if(r&&("Control"==e.key||"Alt"==e.key)||"focusin"==e.type){const r=n?2:1;return void t.reveal(e.target,r)}if(t.revealed instanceof Array){const r=t.revealed.find(t=>t.options.hotkey==e.key);r&&(e.preventDefault(),e.stopPropagation(),r.targetNode.disabled||r.targetNode.click())}}reveal(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=this;if(null!==r.revealed){for(const e of r.revealed)e.targetNode.removeAttribute("data-hotkey");r.revealed.length=0}if(!1===e&&(r.revealed=null),e){const n=r.form.getComponent(e),o=function(e){const t=[e,...e.parents];return[...t,...t.map(S).flat()]}(n),i=o.map((e,t)=>{const r=[];for(const n of e.getTriggers("*")){const e=String(n.options.hotkey||"");if(""==e)continue;const o=n.getTriggerArgs()||{};r.push({tg:n,distance:t,args:o,hotkey:e})}return r}).flat().sort((e,t)=>{const r=e.args.target?.targetNode,o=t.args.target?.targetNode,i=o?.5*o.contains(n.targetNode):0,a=r?.5*r.contains(n.targetNode):0;return+e.distance-t.distance+i-a}),a=new Map;r.revealed=[];for(const n of i){const[o,i]=a.get(n.hotkey)||[1,0];o<t?a.set(n.hotkey,[o+1,n.distance]):o>t||(Object.is(n.tg.targetNode,e)||n.distance>i)&&(n.tg.targetNode.disabled||n.tg.targetNode.setAttribute("data-hotkey",n.hotkey),r.revealed.push(n.tg),a.set(n.hotkey,[o+1,n.distance]))}}}}function S(e){const t=e.parent?.children||[],r=Object.keys(t).findIndex(t=>t===e.name),n=Object.values(t),o=n.slice(0,r).reverse();return[...n.slice(r+1),...o]}const O=function(e,t){let{kind:r,name:n,addInitializer:o}=t;"method"==r&&o(function(){const t=this;this.actions[n]=async function(r){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=!1;if(o.data=r,o.silent||(i=!await t.emit(`BeforeAction_${n}`,o),r=o.data),!i)return r=await e.call(t,r,o),o.data=r,o.silent||t.emit(`AfterAction_${n}`,o),r}})};class L extends x{constructor(e,t){delete t.name;for(var r=arguments.length,n=new Array(r>2?r-2:0),o=2;o<r;o++)n[o-2]=arguments[o];return super(e,t,...n)}render(){const e=this;e.parent.onRendered(()=>{const t=e.getTriggerArgs();"function"==typeof t.context?.onTriggerRender&&t.context.onTriggerRender(t)})}disable(){this.targetNode.disabled=!0}enable(){this.targetNode.disabled=!1}getTriggerArgs(){const e=this,t=[e,...e.parents],{action:r,context:n,target:o,...i}=e.options;if(!r)return;const a=n?e.parent.find(n):t.find(e=>"function"==typeof e.actions[r]),s=o?a?.find(o):n?null:t.slice(1).find(e=>e.parent?.targetNode.isSameNode(a?.targetNode))||null;return{action:r,origin:e,context:a,target:s,...i}}}async function C(e){const t=this.getComponent(e.target).getTriggerArgs();if(!t)return;const{context:r,action:n,data:o}=t,i=r?.actions[n];if("function"!=typeof i)throw this.renderError("UNKNOWN_ACTION",`Unknown action ${n}`+(r?` for ${r.options.type}`:""));return await i(o,t)}class P extends x{constructor(e,t){let{allow_select:r=!1,...n}=t;delete n.name;for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];super(e,{allow_select:r,...n},...i);const s=this;s.eventHooks.click.push(function(e){if(e.defaultPrevented)return;const{target:t}=s.getLabelArgs();t?.targetFieldNode||t.focus()})}async render(){const e=this;for(const t of o(e.targetNode,e.selector)){const r=await e.enhance(t);if(r?._isField)throw e.renderError("FIELD_IN_LABEL",`Non action components not allowed in labels, found ${r.name} in form ${e.getPath()}.`)}e.parent.onRendered(()=>{const t=e.getLabelArgs(),{targetFieldNode:r}=t.target||{};r&&(r.id||(r.id=a()),e.targetNode.setAttribute("for",r.id)),e.options.allow_select||(e.targetNode.style["user-select"]="none")})}getLabelArgs(){const e=this;let t,r;const{context:n,target:o,...i}=e.options;if(n||o)t=n?e.parent.find(n):e.parent,r=o?t.find(o):t;else{t=e.parent;const n=t.targetNode.querySelectorAll(e.selector);let o=!1;for(const t in n)if(o){let o=e.getComponent(n[t]);if(o?._isField){r=o;break}}else Object.is(n[t],e.targetNode)&&(o=!0)}return{origin:e,context:t,target:r,...i}}}const F=function(e,t){let{kind:r}=t;if("class"==r){var o;let t;return class extends e{constructor(){super(...arguments),t(this)}render(){const e=super.render(...arguments),t=this;return t.root.onRendered(()=>{t.fold(null,{operation:t.options.folded?"fold":"unfold"})}),e}fold(e){let{operation:t="toggle",origin:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=this,o="none"==n.targetNode.style.display,i="fold"==t||"unfold"!=t&&!o;n.targetNode.style.display=i?"none":n.originalDisplayProp,n.getTriggers("fold").forEach(e=>{const{foldedClass:t,unfoldedClass:r}=e.options;t&&e.targetNode.classList[i?"add":"remove"](t),r&&e.targetNode.classList[i?"remove":"add"](r)}),n.getTriggers(["addItem","removeItem"]).map(i?e=>e.disable():e=>e.enable()),(i?r:n)?.focus()}static#e=(()=>o=()=>([t]=n(this,[[O,2,"fold"]],[]).e,this))()},o()}},j=function(e,t){let{kind:r}=t;if("method"==r)return async function(t){let{target:r,...n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const o=await e.call(this,t,n);try{await r.import(o)}catch(e){}return o}},D=function(e,t){let{kind:r}=t;if("method"==r)return async function(t){let{target:r,...n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{t=await r.export()}catch(e){}return await e.call(this,t,n)}};var R;let $,M,U;class H extends k{constructor(){super(...arguments),$(this)}async render(){const e=this;e.originalDisplayProp=e.targetNode.style.display;for(const t of o(e.targetNode,e.selector)){const r=await e.enhance(t);if(r?._isField){if(void 0!==e.children[r.name])throw e.renderError("REPEATED_FIELD_NAME",`Field name '${r.name}' used more than once in this form level.`);e.children[r.name]=r,r.updateId()}}}async export(){return Object.fromEntries(await Promise.all(Object.entries(this.children).map(async e=>{let[t,r]=e;return[t,await r.export(null,{silent:!0})]})))}async import(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{focus:t=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=this,n=Object(e).constructor;if(n!=={}.constructor&&!(e=s(e)))throw r.renderError("FORM_NOT_PLAIN_OBJECT",`Expected plain object or vailid JSON for form import, ${n.name} given.`);const o=Object.fromEntries(await Promise.all(Object.entries(r.children).map(async r=>{let[n,o]=r;return[n,await o.import(e[n],{focus:t,silent:!0})]})));return t&&r.focus(),o}async isEmpty(){const e=this;for(const t of Object.values(e.children))if(!await t.isEmpty())return!1;return!0}async clear(e){let{focus:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return await this.import({},{focus:t,silent:!0})}static#e=(()=>R=()=>(({e:[$],c:[U,M]}=n(this,[[[O,j],2,"export"],[[O,D],2,"import"],[O,2,"clear"]],[F])),M()))()}async function B(e){await e.rendered;for(const t of e.getTriggers(["removeItem","addItem"]))t.targetNode.disabled="removeItem"==t.options.action?e.children.length<=e.min_items&&"clear"!=t.options.failback:e.children.length>=e.max_items}R();const J=function(e,t){let{kind:r}=t;return"class"==r?class extends e{async render(){const e=await super.render(...arguments),t=this;return setTimeout(()=>B(t),1),e}}:"method"==r?async function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];const o=await e.call(this,...r);return B(this),o}:void 0},q=Symbol("smart_mutex");class K{constructor(){this.mtx=Promise.resolve()}lock(){let e;const t=new Promise(t=>{e=()=>t()}),r=this.mtx;return this.mtx=t,r.then(function(){return e})}}const W=function(e){return function(t,r){let{kind:n}=r;if("method"==n)return async function(){const r=this;r[q]||(r[q]={}),r[q][e]||(r[q][e]=new K);const n=await r[q][e].lock();let o,i;try{for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];i=await t.call(r,...s)}catch(e){o=e}if(n(),o)throw o;return i}}},z=function(e,t){let{kind:r}=t;if("class"==r){var o;let t,r;return class extends e{constructor(){super(...arguments),t(this)}async[(r=W("list_mutating"),"render")](){const e=await super.render(...arguments),t=this;if(t.sortable=!!t.options.sortable,t.templates.item.setAttribute("draggable",t.sortable),t.children.forEach(e=>e.targetNode.setAttribute("dragable",t.sortable)),t.sortable){let e=null,r=null;t.targetNode.addEventListener("dragstart",t=>{null===e?(e=t.target,t.stopPropagation()):t.preventDefault()}),t.targetNode.addEventListener("dragover",e=>e.preventDefault()),t.targetNode.addEventListener("drop",t=>{if(!e)return;let n=t.target;for(;n.parentElement&&n.parentElement!=e.parentElement;)n=n.parentElement;r=n}),t.targetNode.addEventListener("dragend",async()=>{r&&await t.move({from:t.getComponent(e),to:t.getComponent(r)}),e=null,r=null})}return e}async move(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this;let{from:r,to:n}=e;if(null===n||null===r)return;const o=Number(r?.name),i=Number(n?.name);if(o==i)return;if(o<i){const e=[...t.children.slice(o+1,i+1),t.children[o]];t.children.splice(o,i-o+1,...e)}else if(o>i){const e=[t.children[o],...t.children.slice(i,o)];t.children.splice(i,o-i+1,...e)}const a=(o<i?1:-1)>0?"after":"before";n.targetNode[a](r.targetNode),t.renum()}static#e=(()=>o=()=>([t]=n(this,[[r,2,"move"]],[]).e,this))()},o()}};var G;let V,X,Y,Q,Z,ee;class te extends k{constructor(){super(...arguments),V(this)}async#t(e){const t=this;t.templates.header?t.templates.header.after(e):t.targetNode.appendChild(e)}async[(Y=[W("list_mutating"),O,j],Q=[O,W("list_mutating"),J],Z=[O,W("list_mutating"),J],"render")](){const e=this;e.originalDisplayProp=e.targetNode.style.display,e.min_items=Math.max(0,"number"==typeof e.options.min_items?e.options.min_items:1),e.max_items=Math.max(e.min_items,"number"==typeof e.options.max_items?e.options.max_items:1/0),e.children=[],e.templates=function(e){const t={};for(const r of[...e.targetNode.children]){const{role:n="item"}=s(r.getAttribute("data-smark"))||{};switch(n){case"empty_list":case"header":case"separator":case"last_separator":case"footer":case"placeholder":r.setAttribute("data-role",n);case"item":if(void 0!==t[n])throw e.renderError("LIST_DUPLICATE_TEMPLATE",`Repated list template role ${n}`);t[n]=r,t[n].remove()}}if(e.targetNode.children.length){const{role:t="(unspecified)"}=s(e.targetNode.children[0].getAttribute("data-smark"))||{};throw e.renderError("LIST_UNKNOWN_TEMPLATE_ROLE",`Unknown list template role ${t}`)}if(t.last_separator||(t.last_separator=t.separator),null!==t.item.querySelector("[id]"))throw e.renderError("LIST_CONTAINS_ID","List components are not allowed to contain elements with 'id' attribute");return t}(e),e.placeholders=[];const t=e.getNodeOptions(e.templates.item,{type:e.options.of});if(e.options.of&&t.type!=e.options.of)throw e.renderError("LIST_ITEM_TYPE_MISSMATCH","List item type missmatch");for(const t of[e.templates.header,e.templates.footer])if(t){e.targetNode.appendChild(t);for(const r of o(t,e.selector)){const t=await e.enhance(r);if(t?._isField)throw e.renderError("FIELD_IN_WRONG_LIST_TEMPLATE","Fields are not allowed in list's template roles other than item.")}}e.root.onRendered(async()=>{for(let t=0;t<e.min_items;t++)await e.addItem({silent:!0});0==e.min_items&&await e.renum(),e.targetNode.setAttribute("aria-live","polite"),e.targetNode.setAttribute("aria-atomic","true")})}onTriggerRender(e){let{action:t,origin:r,context:n}=e;switch(t){case"addItem":case"removeItem":1+[...r.parents].findIndex(e=>Object.is(e,n))&&r.options.hotkey&&null===(o=r.targetNode).getAttribute("tabindex")&&o.setAttribute("tabindex","-1")}var o}async export(){const e=this,t=[],r=[],n=!e.inherittedOption("exportEmpties",!1);for(const o of e.children)n&&await o.isEmpty()?t.length<e.min_items&&r.push(o):t.push(await o.export(null,{silent:!0}));for(let n=0;t.length<e.min_items;n++)t.push(await r[n].export(null,{silent:!0}));return t}async import(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],{focus:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=this;e instanceof Array||(e=[e]);for(let n=0;n<Math.min(e.length,r.max_items);n++)r.children.length<=n&&await r.addItem({silent:!0}),await r.children[n].import(e[n],{focus:t,silent:!0});for(let t=Math.max(e.length,r.min_items);t<r.children.length;)await r.removeItem({silent:!0});e.length>r.max_items&&r.emit("error",{code:"LIST_IMPORT_OVERFLOW",message:"Trying to import array greater than list's max_items. Data beyond max_items ignored.",context:r,data:e,options:r.options});for(let t=e.length;t<r.children.length;t++)r.children[t].clear({silent:!0});t&&r.focus()}async addItem(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=this;if(t.action="addItem",t.origin||=null,t.context||=r,t.source||=null,t.target||=null,t.position||="after",t.autoscroll||=null,t.failback||="throw","after"!=t.position&&"before"!=t.position)throw r.renderError("LIST_WRONG_ADDITEM_POSITION",`Invalid value for addItem() position property: ${t.position}`);if(r.children.length>=r.max_items){if("none"===t.failback);else r.emit("error",{code:"LIST_MAX_ITEMS_REACHED",message:"Cannot add items over max_items boundary",options:t});return}r.children.length&&!t.target&&(t.target="before"==t.position?r.children[0]:r.children[r.children.length-1]);const n=r.templates.item.cloneNode(!0);let o;if(r.children.length?r.children=(await Promise.all(r.children.map(async(e,i)=>{if(e.targetNode.isSameNode(t.target.targetNode)){e.targetNode[t.position](n),o=await r.enhance(n,{type:"form"}),await o.rendered;const i=[e,o];return"before"==t.position&&i.reverse(),i}return e}))).flat():(await r.#t(n),o=await r.enhance(n,{type:"form",name:0}),await o.rendered,r.children.push(o),o.name=0),await r.renum(),t.source){const e=o.find(t.source);if(e){const t=await e.export();await o.import(t,{silent:!0})}}if("elegant"==t.autoscroll&&o)i(o.targetNode,-o.offsetHeight);else{const e=o?"self"==t.autoscroll?o:"parent"==t.autoscroll?o.parent:null:null;e&&e.moveTo()}return r.renderedSync&&o.focus(),o}async removeItem(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=this;t.action="removeItem",t.origin||=null,t.context||=r,t.target||=null,t.autoscroll||=null;let n=t.preserve_non_empty||=!1;if(t.failback||="throw",!t.target){if(n)for(const e of[...r.children].reverse())if(await e.isEmpty()){t.target=e;break}t.target||(t.target=r.children[r.children.length-1],n=!1)}const o=t.target instanceof Array?t.target:[t.target];for(const e of[...o].reverse()){if(r.children.length<=r.min_items)switch(t.failback){case"none":break;case"clear":return void await e.clear({silent:!0});default:return void r.emit("error",{code:"LIST_MIN_ITEMS_REACHED",message:"Cannot remove items under min_items boundary",options:t})}if(n&&!await e.isEmpty())continue;let o=null,a=null;const s=r.children.filter((r,n,s)=>{if(r.targetNode.isSameNode(e.targetNode)){if("elegant"==t.autoscroll)i(r.targetNode,r.targetNode.offsetHeight);else{const e="self"==t.autoscroll?r:"parent"==t.autoscroll?r.parent:null;e&&e.moveTo()}return o=r,a=s.length-n>1?a=n:0==n?null:n-1,!1}return!0});await r.emit("removeItem_beforeRender",{...t,target:o,targetNode:o.targetNode},!1),await o.unrender(),r.children=s,await r.renum(),await r.emit("removeItem_afterRender",{...t,target:o,targetNode:o.targetNode},!1),null!==a&&r.children[a].focus()}}async isEmpty(){const e=this;for(const t of e.children)if(!await t.isEmpty())return!1;return!0}async clear(e){let{focus:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return await this.import([],{focus:t,silent:!0})}count(e){let{delta:t=0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.children.length+Number(t)}position(e){let{target:t,offset:r=1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Number(t?.name)+Number(r)}async renum(){const e=this;for(const t in e.children)e.children[t].name=t,e.children[t].updateId();if(e.templates.separator||e.templates.last_separator)for(const t in e.children){const r=t>=e.children.length-1,n=t<=0?null:r?"last_separator":"separator",o=e.children[t].targetNode,i=o.previousElementSibling,a=i&&i.getAttribute("data-role");if(a!==n){a&&i.remove();const t=e.templates[n];n&&t&&o.parentElement.insertBefore(t.cloneNode(!0),o)}if(r){const e=o.nextElementSibling;e&&e.remove()}}if(e.templates.empty_list&&(e.children.length?e.templates.empty_list.remove():await e.#t(e.templates.empty_list)),e.templates.placeholder&&e.max_items){let t=(e.max_items||0)-e.children.length;if(t>0&&0===e.children.length&&e.templates.empty_list&&t--,e.placeholders.length<t)for(let r=e.placeholders.length;r<t;r++){const t=e.templates.placeholder.cloneNode(!0);e.templates.footer?e.templates.footer.before(t):e.targetNode.appendChild(t),e.placeholders.push(t)}else for(let r=e.placeholders.length;r>t;r--)e.placeholders.pop().remove()}e.getTriggers("position").forEach(e=>{const t=e.getTriggerArgs();e.targetNode.innerText=this.position(t.data,{...t,silent:!0})}),e.getTriggers("count").forEach(e=>{const t=e.getTriggerArgs();e.targetNode.innerText=this.count(t.data,{...t,silent:!0})})}static#e=(()=>G=()=>(({e:[V],c:[ee,X]}=n(this,[[Y,2,"export"],[[O,D],2,"import"],[Q,2,"addItem"],[Z,2,"removeItem"],[O,2,"clear"],[O,2,"count"],[O,2,"position"]],[F,z,J])),X()))()}var re;let ne;G();class oe extends U{constructor(){ne(super(...arguments));this.eventHooks.keydown.push(function(e){if(!e.defaultPrevented&&"Enter"===e.originalEvent.key){const t=e.originalEvent.shiftKey;if("TEXTAREA"===e.context.targetNode.tagName&&!e.originalEvent.ctrlKey&&!t)return;let r=t?e.context.find(".-1")||e.context.find("../.-1"):e.context.find(".+1")||e.context.find("../.+1");r&&(r.focus(),e.originalEvent.preventDefault(),e.originalEvent.stopPropagation())}})}async render(){const e=this;if(e.isSingleton=!("INPUT"===e.targetNode.tagName||"SELECT"===e.targetNode.tagName||"TEXTAREA"===e.targetNode.tagName),e.isCheckbox=!e.isSingleton&&"checkbox"==String(e.targetNode.type).toLowerCase(),e.isSingleton){await super.render();const t=Object.values(e.children);if(1!=t.length)throw e.renderError("NOT_A_SINGLETON",`Singleton forms are only allowed to contain exactly one data field but ${t.length} found.`);const r=t[0];if(e.options.type!==r.options.type)throw e.renderError("SINGLETON_TYPE_MISMATCH",`Singleton type (${e.options.type}) does not match child field type (${r.options.type}).`);e.targetFieldNode=r.targetNode}else e.targetFieldNode=e.targetNode}async export(e,t){const r=this;if(r.isSingleton)return await r.children[""].export(e,t);const n=r.targetFieldNode;let o;return o=r.isCheckbox?!!n.checked:"json"===r.options.encoding&&"SELECT"===n.tagName.toUpperCase()&&null===n.options[n.selectedIndex]?.getAttribute("value")?JSON.stringify(n.options[n.selectedIndex].text):n.value,"json"===r.options.encoding?s(o)||null:o}async import(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=this;if(r.isSingleton)return await r.children[""].import(e,t);let{focus:n=!0}=t;const o=r.targetFieldNode;if("object"==typeof e&&"input"===r.options.type||"json"===r.options.encoding){e||=null;e=("TEXTAREA"===o.tagName.toUpperCase()?JSON.stringify(e,null,4):JSON.stringify(e))||""}if(r.isCheckbox)r.targetNode.checked=!!e;else if("json"===r.options.encoding&&"SELECT"===o.tagName.toUpperCase()){if(r.targetNode.value=e||"null",-1===o.selectedIndex){const t=s(e)||"",r=Array.from(o.options).findIndex(e=>e.text===t);-1!==r&&(o.selectedIndex=r)}}else r.targetNode.value=e;return n&&r.focus(),r.targetNode.value}async isEmpty(){return!(this.isCheckbox?"":await this.export(null,{silent:!0})).trim().length}async clear(e){let{focus:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};await this.import("json"===this.options.encoding?null:"",{focus:t})}static#e=(()=>re=()=>[ne]=n(this,[[[O,j],2,"export"],[[O,D],2,"import"],[O,2,"clear"]],[]).e)()}var ie;let ae;re();class se extends oe{constructor(){super(...arguments),ae(this)}async render(){await super.render();const e=this,t=e.targetFieldNode.tagName,r=e.targetFieldNode.getAttribute("type");if("INPUT"!=t||"number"!=(r||"number").toLowerCase())throw e.renderError("NOT_A_NUMBER_FIELD",'Number inputs require an INPUT tag of type "number".');r||(e.targetFieldNode.type="number")}async export(){const e=await super.export(...arguments);return this.isSingleton?e:e.length&&!isNaN(e)?Number(e):null}async import(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=typeof e;if(this.isSingleton)return await super.import(e,t);return await super.import("number"==r?e:"string"==r&&e.length&&!isNaN(e)?Number(e):null,t)}async isEmpty(){return null===await this.export(null,{silent:!0})}static#e=(()=>ie=()=>[ae]=n(this,[[O,2,"export"],[O,2,"import"]],[]).e)()}var le;let ce;ie();const de=/T.*/;function ue(e){return 8==e.length?new Date([e.substring(0,4),e.substring(4,6),e.substring(6,8)].join("-")):10==e.length&&"-"==e[4]&&"-"==e[7]?new Date(e):NaN}function pe(e){return e.toISOString().replace(de,"")}class ge extends oe{constructor(){super(...arguments),ce(this)}async render(){await super.render();const e=this,t=e.targetFieldNode.tagName,r=e.targetFieldNode.getAttribute("type");if("INPUT"!=t||"date"!=(r||"date").toLowerCase())throw e.renderError("NOT_A_DATE_FIELD",'Date inputs require an INPUT tag of type "date".');r||(e.targetFieldNode.type="date")}async export(){const e=await super.export(...arguments);if(this.isSingleton)return e;if(!e.length)return null;const t=ue(e);return isNaN(t)?null:pe(t)}async import(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,{focus:t=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.isSingleton)return await super.import(e,{focus:t});const r=e instanceof Date?e:"number"==typeof e?new Date(e):e&&"string"==typeof e?ue(e):NaN;return await super.import(isNaN(r)?null:pe(r),{focus:t})}async isEmpty(){return null===await this.export(null,{silent:!0})}static#e=(()=>le=()=>[ce]=n(this,[[O,2,"export"],[O,2,"import"]],[]).e)()}var fe;let he;le();class ye extends oe{constructor(){he(super(...arguments));const e=this;let t=e.parent.children[e.name],r=e;t?(e.targetNode.setAttribute("name",t.sharedNodeName),t.radioButtons.push(e.targetNode),r={}):(t=e,t.sharedNodeName=a(),t.targetNode.setAttribute("name",t.sharedNodeName),t.radioButtons=[t.targetNode]);let n=Ne.bind(t);return e.targetNode.addEventListener("click",n),e.targetNode.addEventListener("keydown",n),r}async render(){await super.render();const e=this,t=e.targetFieldNode.tagName,r=e.targetFieldNode.getAttribute("type");if("INPUT"!=t||"radio"!=(r||"radio").toLowerCase())throw e.renderError("NOT_A_RADIO_FIELD",'Radio inputs require an INPUT tag of type "radio".');r||(e.targetFieldNode.type="radio")}async export(){return this.radioButtons.find(e=>e.checked)?.value||null}async import(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,{focus:t=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=this.radioButtons.find(t=>t.value===e);r?r.checked=!0:this.radioButtons.forEach(e=>e.checked=!1),t&&this.focus()}async isEmpty(){return!(1+this.radioButtons.findIndex(e=>e.checked))}static#e=(()=>fe=()=>[he]=n(this,[[[O,j],2,"export"],[[O,D],2,"import"]],[]).e)()}function Ne(e){if("click"===e.type||"keydown"===e.type&&"Delete"===e.code){const t=this;let r=!0;Object.is(t.lastClicked?.target,e.target)&&(r=!t.lastClicked.checked&&"keydown"!==e.type),t.lastClicked={target:e.target,checked:r},e.target.checked=r}}var ve;let be;fe();const we=/^#([a-f0-9]{3}){1,2}$/i,Ee="\n    opacity: .5;\n    background: repeating-linear-gradient(\n            45deg,\n            black,\n            black 10px,\n            white 10px,\n            white 20px\n        ),\n        black;\n    background-blend-mode: difference;\n";class _e extends oe{constructor(){be(super(...arguments)),this.eventHooks.keydown.push(e=>{e.defaultPrevented||"Delete"===e.originalEvent.key&&e.context.clear()})}async render(){await super.render();const e=this;if(e.isSingleton)return;const t=e.targetFieldNode.tagName,r=e.targetFieldNode.getAttribute("type");if("INPUT"!=t||"color"!=(r||"color").toLowerCase())throw e.renderError("NOT_A_COLOR_FIELD",'Color inputs require an INPUT tag of type "color".');r||(e.targetFieldNode.type="color");const n=e.targetFieldNode.getAttribute("value");e.isDefined=null!==n&&""!==n.trim(),e.defaultStyleAttr=e.targetFieldNode.getAttribute("style")+";",e.isDefined||e.targetFieldNode.setAttribute("style",e.defaultStyleAttr+Ee);const o=t=>{"Enter"!==t.code&&"Space"!==t.Code&&void 0!==t.code||(e.isDefined=!0,e.targetFieldNode.setAttribute("style",e.defaultStyleAttr))};e.targetFieldNode.addEventListener("keydown",o),e.targetFieldNode.addEventListener("click",o),e.targetFieldNode.addEventListener("change",o)}async export(){let e=await super.export(...arguments);return this.isSingleton||(e=this.isDefined&&e.match(we)?e.toLowerCase():null),e}async import(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=this;r.isSingleton||(null!==e&&e.match(we)?(r.isDefined=!0,r.targetFieldNode.setAttribute("style",r.defaultStyleAttr)):(r.isDefined=!1,r.targetFieldNode.setAttribute("style",r.defaultStyleAttr+Ee))),4==e?.length&&(e=`#${e[1]}${e[1]}${e[2]}${e[2]}${e[3]}${e[3]}`);const n=await super.import(e,t);return r.isDefined?n:null}async isEmpty(){return null===await this.export(null,{silent:!0})}static#e=(()=>ve=()=>[be]=n(this,[[O,2,"export"],[O,2,"import"]],[]).e)()}ve();for(const[e,t]of Object.entries({trigger:L,label:P,form:U,list:ee,input:oe,number:se,date:ge,radio:ye,color:_e}))T(e,t);class xe extends U{constructor(e){let{customActions:t={},...r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n={...r,name:"",type:"form"};super(e,n,null);const o=this;o.setNodeOptions(o.targetNode,n),o.actions={...o.actions,...Object.fromEntries(Object.entries(t).map(e=>{let[t,r]=e;return[t,r.bind(o)]}))},o.targetNode.addEventListener("click",C.bind(o),!0),new I(o)}async render(){this.targetNode.setAttribute("aria-busy","true"),await super.render(),this.targetNode.setAttribute("aria-busy","false")}}xe.createType=T;export{xe as default};//# sourceMappingURL=SmarkForm.esm.js.map
