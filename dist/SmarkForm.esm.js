function t(t){if(Object(t)!==t)throw TypeError("right-hand side of 'in' should be an object, got "+(null!==t?typeof t:"null"));return t}function e(t,e,r){"symbol"==typeof e&&(e=(e=e.description)?"["+e+"]":"");try{Object.defineProperty(t,"name",{configurable:!0,value:r?r+" "+e:e})}catch(t){}return t}function r(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"==typeof e?e:e+""}function n(o,i,a,s){return(n=function(){function n(t,e){return function(r){!function(t){if(t.v)throw Error("attempted to call addInitializer after decoration was finished")}(e),a(r,"An initializer"),t.push(r)}}function o(t,e){if(!t(e))throw new TypeError("Attempted to access private element on non-instance")}function i(t,e,i,a,s,l,c,d,u){var p;switch(s){case 1:p="accessor";break;case 2:p="method";break;case 3:p="getter";break;case 4:p="setter";break;default:p="field"}var f,g,h={kind:p,name:c?"#"+e:r(e),static:l,private:c},m={v:!1};if(0!==s&&(h.addInitializer=n(a,m)),c||0!==s&&2!==s)if(2===s)f=function(t){return o(u,t),i.value};else{var y=0===s||1===s;(y||3===s)&&(f=c?function(t){return o(u,t),i.get.call(t)}:function(t){return i.get.call(t)}),(y||4===s)&&(g=c?function(t,e){o(u,t),i.set.call(t,e)}:function(t,e){i.set.call(t,e)})}else f=function(t){return t[e]},0===s&&(g=function(t,r){t[e]=r});var N=c?u.bind():function(t){return e in t};h.access=f&&g?{get:f,set:g,has:N}:f?{get:f,has:N}:{set:g,has:N};try{return t(d,h)}finally{m.v=!0}}function a(t,e){if("function"!=typeof t)throw new TypeError(e+" must be a function")}function s(t,e){var r=typeof e;if(1===t){if("object"!==r||null===e)throw new TypeError("accessor decorators must return an object with get, set, or init properties or void 0");void 0!==e.get&&a(e.get,"accessor.get"),void 0!==e.set&&a(e.set,"accessor.set"),void 0!==e.init&&a(e.init,"accessor.init")}else if("function"!==r)throw new TypeError((0===t?"field":10===t?"class":"method")+" decorators must return a function or void 0")}function l(t){return function(e){t(this,e)}}function c(t,r,n,o,a,c,d,u,p){var f,g,h,m,y,N,v,w,b=n[0];if(d?(0===a||1===a?(f={get:(y=n[3],function(){return y(this)}),set:l(n[4])},h="get"):3===a?(f={get:n[3]},h="get"):4===a?(f={set:n[3]},h="set"):f={value:n[3]},0!==a&&(1===a&&e(f.set,"#"+o,"set"),e(f[h||"value"],"#"+o,h))):0!==a&&(f=Object.getOwnPropertyDescriptor(r,o)),1===a?m={get:f.get,set:f.set}:2===a?m=f.value:3===a?m=f.get:4===a&&(m=f.set),"function"==typeof b)void 0!==(N=i(b,o,f,u,a,c,d,m,p))&&(s(a,N),0===a?g=N:1===a?(g=N.init,v=N.get||m.get,w=N.set||m.set,m={get:v,set:w}):m=N);else for(var E=b.length-1;E>=0;E--){var _;void 0!==(N=i(b[E],o,f,u,a,c,d,m,p))&&(s(a,N),0===a?_=N:1===a?(_=N.init,v=N.get||m.get,w=N.set||m.set,m={get:v,set:w}):m=N,void 0!==_&&(void 0===g?g=_:"function"==typeof g?g=[g,_]:g.push(_)))}if(0===a||1===a){if(void 0===g)g=function(t,e){return e};else if("function"!=typeof g){var x=g;g=function(t,e){for(var r=e,n=0;n<x.length;n++)r=x[n].call(t,r);return r}}else{var A=g;g=function(t,e){return A.call(t,e)}}t.push(g)}0!==a&&(1===a?(f.get=m.get,f.set=m.set):2===a?f.value=m:3===a?f.get=m:4===a&&(f.set=m),d?1===a?(t.push(function(t,e){return m.get.call(t,e)}),t.push(function(t,e){return m.set.call(t,e)})):2===a?t.push(m):t.push(function(t,e){return m.call(t,e)}):Object.defineProperty(r,o,f))}function d(e,r,n){for(var o,i,a,s=[],l=new Map,d=new Map,p=0;p<r.length;p++){var f=r[p];if(Array.isArray(f)){var g,h,m=f[1],y=f[2],N=f.length>3,v=m>=5,w=n;if(v?(g=e,0!=(m-=5)&&(h=i=i||[]),N&&!a&&(a=function(r){return t(r)===e}),w=a):(g=e.prototype,0!==m&&(h=o=o||[])),0!==m&&!N){var b=v?d:l,E=b.get(y)||0;if(!0===E||3===E&&4!==m||4===E&&3!==m)throw Error("Attempted to decorate a public method/accessor that has the same name as a previously decorated public method/accessor. This is not currently supported by the decorators plugin. Property name was: "+y);!E&&m>2?b.set(y,m):b.set(y,!0)}c(s,g,f,y,m,v,N,h,w)}}return u(s,o),u(s,i),s}function u(t,e){e&&t.push(function(t){for(var r=0;r<e.length;r++)e[r].call(t);return t})}return function(t,e,r,o){return{e:d(t,e,o),get c(){return function(t,e){if(e.length>0){for(var r=[],o=t,i=t.name,a=e.length-1;a>=0;a--){var l={v:!1};try{var c=e[a](o,{kind:"class",name:i,addInitializer:n(r,l)})}finally{l.v=!0}void 0!==c&&(s(10,c),o=c)}return[o,function(){for(var t=0;t<r.length;t++)r[t].call(o)}]}}(t,r)}}}}())(o,i,a,s)}function o(t,e){const r=null===t.parentNode?t=>null===t:e=>null===e||e.isSameNode(t);return[...t.querySelectorAll(e)].filter(t=>r(t.parentNode.closest(e)))}function i(t,e){let r=t.parentNode;const n=e>=0?1:-1;for(;r;){if(r.scrollHeight>r.clientHeight*n){var o=r.scrollHeight-r.clientHeight*n;if(e<=o*n)return void(r.scrollTop+=e);r.scrollTop=o,e-=o}r=r.parentNode}}function a(){return Math.random().toString(36).substring(2)}function s(t){try{return JSON.parse(t)}catch(t){}}const l=Symbol("Events"),c=Symbol("allEvents"),d=/^on(?:Before|After)Action_/,u=/^onLocal_/,p=/^onAll_/,f=["keydown","keyup","keypress","beforeinput","input","change","focus","blur","click","dblclick","contextmenu","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","focusin","focusout"];function g(t,e,r){return t.has(e)||t.set(e,[]),t.get(e).push(r.bind(this)),this}const h=function(t,e){let{kind:r}=e;if("class"==r)return class extends t{constructor(t,e){const r={},n=[];for(const[t,o]of Object.entries(e))t.match(d)?n.push([t.substring(2),o,"onLocal"]):t.match(u)?n.push([t.substring(8),o,"onLocal"]):t.match(p)?n.push([t.substring(6),o,"onAll"]):r[t]=o;for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];super(t,r,...i);const s=this;if(s[l]=new Map,s[c]=new Map,s.onLocal=g.bind(s,s[l]),s.onAll=g.bind(s,s[c]),s.on=s.onAll,s.eventHooks=function(t){const e={};for(const r in t)e[r]=[...t[r]];return Object.defineProperty(e,"_dynamic",{get(){return new Proxy(this,{get:(t,e)=>(e in t||(t[e]=[]),t[e])})}}),e._dynamic}(super.eventHooks),Object.is(s,s.root))for(const t of f)s.targetNode.addEventListener(t,e=>{const r=s.getComponent(e.target),n={type:t,originalEvent:e,context:r,preventDefault:e.preventDefault.bind(e),stopPropagation:e.stopPropagation.bind(e),stopImmediatePropagation:e.stopImmediatePropagation.bind(e)};r.emit(t,n)},!0);for(const[t,e,r]of n)s[r](t,e)}async emit(t,e){const r=this,n=[...r[l].get(t)||[],...r[c].get(t)||[]];for(const t of n)await t(e);for(const n of r.parents){const r=n[c].get(t)||[];for(const t of r)await t(e)}for(const n of r.eventHooks[t])await n(e);return!0}}};var m,y={disEnhance(t){t.targetNode.tagName.toLowerCase()&&t.targetNode.addEventListener("submit",function(t){t.preventDefault()})}};let N;const v={},w=Symbol("smart_component"),b=/^[a-z0-9_]+$/i,E=/[\*\?]/,_=class extends Error{constructor(t,e,r){super(`RenderError(${r}): ${e}`),this.code=t,this.path=r,this.stack=this.stack.split("\n").slice(2).join("\n")}};let x;class A{constructor(t){let{property_name:e="smark",...r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;const o=this;if(o.validName=function(){let t=0;return function(){if(o.parent.isSingleton)return"";for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];for(let t of r)if("string"==typeof t&&(t=t.trim(),t.length))return t;return"UNNAMED"+ ++t}}(),o.actions={},o.property_name=e,o.selector=`[data-${o.property_name}]`,o.types=v,o.targetNode=t,o.options=r,o.setNodeOptions(o.targetNode,o.options),o.parent=n,!o.parent instanceof x)throw o.renderError("INVALID_PARENT","Smark Components must have valid Smark Component parent.");o.root=null===o.parent?o:o.parent.root,o.parents={},o.parents[Symbol.iterator]=function*(){let t=o;for(;t;)yield t,t=t.parent};const i=o.inherittedOption("autoId",!1);let a;o.genId=!1!==i&&(!0===i?t=>t.replace(/\//g,"_"):"string"==typeof i?t=>i+t.replace(/\//g,"_"):"function"==typeof i&&i),o.onRenderedTasks=[],o.renderedSync=!1,o.rendered=new Promise(t=>a=t),o.children={},o.targetNode[w]=o,(async()=>{await o.render();for(const t of o.onRenderedTasks)await t();o.onRenderedTasks=null,a(!0),setTimeout(()=>o.renderedSync=!0,1)})(),o.options.onRendered&&o.onRendered(o.options.onRendered)}onRendered(t){const e=this;e.onRenderedTasks?e.onRenderedTasks.push(t.bind(e)):t.bind(e)()}getNodeOptions(t,e){const r=this,n=(t.dataset[r.property_name]||"").trim()||null,o={...e,...(()=>{try{const t=JSON.parse(n);if("object"!=typeof t)throw new Error("NO_OBJECT");return t}catch(t){return n.match(b)?{type:n}:{}}})()};return o.action||o.type||(o.type=function(t,e){switch(t.tagName.toLowerCase()){case"ul":case"ol":case"table":case"thead":case"tbody":case"tfoot":return"list";case"input":const r=String(t.getAttribute("type")||"").toLowerCase();if(e.isSingleton)return e.options.type;switch(r){case"number":case"date":case"radio":case"color":return r}case"textarea":case"select":return"input";case"label":return"label";default:return"form"}}(t,r)),r.setNodeOptions(t,o),o}setNodeOptions(t,e){t.dataset[this.property_name]=JSON.stringify(e)}async enhance(t,e){const r=this;let n=r.getNodeOptions(t,e);if(y.disEnhance(r),n.action){if(n.type||(n.type="trigger"),"trigger"!=n.type)throw r.renderError("ACTION_IN_NON_TRIGGER",`"action" property is only allowed for "trigger" components but "${n.type}" type specified.`)}else if("string"!=typeof n.type)throw r.renderError("NO_TYPE_PROVIDED","Invalid SmarkForm item: type is mandatory for non trigger components.");const o=r.types[n.type];if(!o)throw r.renderError("UNKNOWN_TYPE",`Unimplemented SmarkForm component controller: ${n.type}`);return new o(t,n,r)}getComponent(t){return t[w]||t.parentElement?.closest(this.selector)[w]||null}getPath(){return[...this.parents].map(t=>t.name).reverse().join("/")||"/"}find(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";let e=this;if(""===e.name&&e.parent.isSingleton&&(e=e.parent),t=String(t),"/"==t[0])for(;e.parent;)e=e.parent;const r=t.split("/").filter(t=>t),n=r.findIndex(t=>t.match(E));if(n>=0){const t=(o=r[n],new RegExp("^"+o.replace(/\*+/g,".*").replace(/\?/g,".")+"$")),i=r.slice(0,n).join("/"),a=r.slice(n+1).join("/"),s=e.find(i);return Object.entries(s.children).filter(e=>{let[r,n]=e;return n&&r.match(t)}).map(t=>{let[,e]=t;return e.find(a)}).flat(1/0)}var o;return r.reduce((t,e)=>{if(void 0!==t){if(".."==e)return t.parent;if("."!=e[0])return t.children[e];{if("."==e)return t;if(!t.parent)return;const r=parseInt(e.slice(1));if(isNaN(r))return;if("list"!=t.parent.options.type){const e=Object.keys(t.parent.children),n=e.findIndex(e=>e==t.name),o=e[n+r];return t.parent.children[o]}{const e=parseInt(t.name)+r;if(!isNaN(e))return t.parent.children[e]}}}},e)}inherittedOption(t,e){const r=this;for(const e of r.parents)if(void 0!==e.options[t])return e.options[t];return e}moveTo(){const t=this;t.targetNode.id||(t.targetNode.id=t.getPath()),document.location.hash=t.targetNode.id,window.history.pushState({},void 0,window.location.pathname)}getTriggers(){const t=this,e=[],r=new Set([arguments.length>0&&void 0!==arguments[0]?arguments[0]:""].flat().map(String).filter(t=>t)),n=r.has("*");for(const o of[...t.root.targetNode.querySelectorAll(t.selector)].map(t=>t[w]).filter(t=>t)){const i=o.getTriggerArgs();i&&(Object.is(i.context,t)&&(n||r.has(i.action))&&e.push(o))}return e}updateId(){const t=this;if(!1===t.genId)return;const e=t.genId(t.getPath());if(t.targetNode.id!=e){t.targetNode.id=e;for(const e of Object.values(t.children))e.updateId()}return t.targetNode.id}focus(){const t=this;for(const e in t.children)return t.children[e].focus();t.targetFieldNode&&t.targetFieldNode.focus()}getTriggerArgs(){}renderError(t,e){return new _(t,e,this.getPath())}static#t=(()=>m=()=>([x,N]=n(this,[],[h]).c,N()))()}m();class k extends x{constructor(){if(super(...arguments),this._isField=!0,!Object.is(this,this.root)&&(this.name=this.validName(this.options.name,this.targetNode.getAttribute("name")),this.options.hasOwnProperty("value"))){if(null!==this.targetNode.getAttribute("value"))throw me.renderError("VALUE_CONFLICT",'Initial value specied both as "value" option and HTML "value" attribute.');this.targetNode.setAttribute("value",this.options.value)}}}function T(t,e){if(void 0!==v[t])throw new Error(`Duplicate component type definition: ${t}`);if(!(e.prototype instanceof x))throw new Error(`Bad component type implementation for: ${t}`);v[t]=e}class I{constructor(t){const e=this;e.form=t,e.revealed=null;const r=I.onStatusChange.bind(e);e.form.targetNode.addEventListener("keydown",r,!0),e.form.targetNode.addEventListener("keyup",r,!0),e.form.targetNode.addEventListener("focusout",r,!0),e.form.targetNode.addEventListener("focusin",r,!0)}static onStatusChange(t){const e=this;if("keyup"==t.type)return void("Control"==t.key&&e.reveal(!1));if("focusout"==t.type)return void(null!==e.revealed&&e.reveal());if("focusin"==t.type&&null===e.revealed)return;const r=t.ctrlKey||"Control"==t.key,n=t.altKey||"Alt"==t.key;if(r&&("Control"==t.key||"Alt"==t.key)||"focusin"==t.type){const r=n?2:1;return void e.reveal(t.target,r)}if(e.revealed instanceof Array){const r=e.revealed.find(e=>e.options.hotkey==t.key);r&&(t.preventDefault(),t.stopPropagation(),r.targetNode.disabled||r.targetNode.click())}}reveal(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=this;if(null!==r.revealed){for(const t of r.revealed)t.targetNode.removeAttribute("data-hotkey");r.revealed.length=0}if(!1===t&&(r.revealed=null),t){const n=r.form.getComponent(t),o=[n,...n.parents],i=new Set(o),a=o.map((t,e)=>t.getTriggers("*").map(t=>({tg:t,distance:e,args:t.getTriggerArgs()||{},hotkey:String(t.options.hotkey||"")}))).flat().filter(t=>{let{args:e,hotkey:r}=t;return r.length&&i.has(e.context)}).sort((t,e)=>i.has(e.args.target)-i.has(t.args.target)-e.distance+t.distance),s=new Map;r.revealed=[];for(const t of a){const[n,o]=s.get(t.hotkey)||[1,0];n<e?s.set(t.hotkey,[n+1,t.distance]):n>e||t.distance>o&&(t.tg.targetNode.disabled||t.tg.targetNode.setAttribute("data-hotkey",t.hotkey),r.revealed.push(t.tg),s.set(t.hotkey,[n+1,t.distance]))}}}}const S=function(t,e){let{kind:r,name:n,addInitializer:o}=e;"method"==r&&o(function(){const e=this;this.actions[n]=async function(){let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=!1;if(r.silent||(o=!await e.emit(`BeforeAction_${n}`,r)),o)return;const i=await t.call(e,r);return r.silent||e.emit(`AfterAction_${n}`,{...r,data:i}),i}})};class O extends x{constructor(t,e){delete e.name;for(var r=arguments.length,n=new Array(r>2?r-2:0),o=2;o<r;o++)n[o-2]=arguments[o];return super(t,e,...n)}render(){const t=this;t.parent.onRendered(()=>{const e=t.getTriggerArgs();"function"==typeof e.context?.onTriggerRender&&e.context.onTriggerRender(e)})}disable(){this.targetNode.disabled=!0}enable(){this.targetNode.disabled=!1}getTriggerArgs(){const t=this,e=[...t.parents],{action:r,context:n,target:o,...i}=t.options;if(!r)return;const a=n?t.parent.find(n):e.find(t=>"function"==typeof t.actions[r]),s=o?a?.find(o):n?null:e.slice(1).find(t=>t.parent?.targetNode.isSameNode(a?.targetNode))||null;return{action:r,origin:t,context:a,target:s,...i}}}async function L(t){const e=this.getComponent(t.target).getTriggerArgs();if(!e)return;const{context:r,action:n}=e,o=r?.actions[n];if("function"!=typeof o)throw this.renderError("UNKNOWN_ACTION",`Unknown action ${n}`+(r?` for ${r.options.type}`:""));return await o(e)}class C extends x{constructor(t,e){let{allow_select:r=!1,...n}=e;delete n.name;for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];return super(t,{allow_select:r,...n},...i)}async render(){const t=this;for(const e of o(t.targetNode,t.selector)){const r=await t.enhance(e);if(r?._isField)throw t.renderError("FIELD_IN_LABEL",`Non action components not allowed in labels, found ${r.name} in form ${t.getPath()}.`)}t.parent.onRendered(()=>{const e=t.getLabelArgs(),{targetFieldNode:r}=e.target||{};r&&(r.id||(r.id=a()),t.targetNode.setAttribute("for",r.id)),t.options.allow_select||(t.targetNode.style["user-select"]="none")})}getLabelArgs(){const t=this;let e,r;t.parents;const{context:n,target:o,...i}=t.options;if(n||o)e=n?t.parent.find(n):t.parent,r=o?e.find(o):e;else{e=t.parent;const n=e.targetNode.querySelectorAll(t.selector);let o=!1;for(const e in n)if(o){let o=t.getComponent(n[e]);if(o?._isField){r=o;break}}else Object.is(n[e],t.targetNode)&&(o=!0)}return{origin:t,context:e,target:r,...i}}}const P=function(t,e){let{kind:r}=e;if("class"==r){var o;let e;return class extends t{constructor(){super(...arguments),e(this)}render(){const t=super.render(...arguments),e=this;return e.root.onRendered(()=>{e.fold({operation:e.options.folded?"fold":"unfold"})}),t}fold(){let{operation:t="toggle"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this,r="none"==e.targetNode.style.display,n="fold"==t||"unfold"!=t&&!r;e.targetNode.style.display=n?"none":e.originalDisplayProp,e.getTriggers("fold").forEach(t=>{const{foldedClass:e,unfoldedClass:r}=t.options;e&&t.targetNode.classList[n?"add":"remove"](e),r&&t.targetNode.classList[n?"remove":"add"](r)}),e.getTriggers(["addItem","removeItem"]).map(n?t=>t.disable():t=>t.enable())}static#t=(()=>o=()=>([e]=n(this,[[S,2,"fold"]],[]).e,this))()},o()}},D=function(t,e){let{kind:r}=e;if("method"==r)return async function(){let{target:e,...r}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const n=await t.call(this,r);try{await e.import({data:n})}catch(t){}return n}},F=function(t,e){let{kind:r}=e;if("method"==r)return async function(){let{target:e,data:r,...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{r=await e.export()}catch(t){}return await t.call(this,{data:r,...n})}};var j;let R,$,M;class U extends k{constructor(){super(...arguments),R(this)}async render(){const t=this;t.originalDisplayProp=t.targetNode.style.display;for(const e of o(t.targetNode,t.selector)){const r=await t.enhance(e);if(r?._isField){if(void 0!==t.children[r.name])throw t.renderError("REPEATED_FIELD_NAME",`Field name '${r.name}' used more than once in this form level.`);t.children[r.name]=r,r.updateId()}}}async export(){return Object.fromEntries(await Promise.all(Object.entries(this.children).map(async t=>{let[e,r]=t;return[e,await r.export({silent:!0})]})))}async import(){let{data:t={},focus:e=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this,n=Object(t).constructor;if(n!=={}.constructor&&!(t=s(t)))throw r.renderError("FORM_NOT_PLAIN_OBJECT",`Expected plain object or vailid JSON for form import, ${n.name} given.`);const o=Object.fromEntries(await Promise.all(Object.entries(r.children).map(async r=>{let[n,o]=r;return[n,await o.import({data:t[n],focus:e,silent:!0})]})));return e&&r.focus(),o}async isEmpty(){const t=this;for(const e of Object.values(t.children))if(!await e.isEmpty())return!1;return!0}async clear(){let{focus:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return await this.import({data:{},focus:t,silent:!0})}static#t=(()=>j=()=>(({e:[R],c:[M,$]}=n(this,[[[S,D],2,"export"],[[S,F],2,"import"],[S,2,"clear"]],[P])),$()))()}async function H(t){await t.rendered;for(const e of t.getTriggers(["removeItem","addItem"]))e.targetNode.disabled="removeItem"==e.options.action?t.children.length<=t.min_items&&"clear"!=e.options.failback:t.children.length>=t.max_items}j();const B=function(t,e){let{kind:r}=e;return"class"==r?class extends t{async render(){const t=await super.render(...arguments),e=this;return setTimeout(()=>H(e),1),t}}:"method"==r?async function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];const o=await t.call(this,...r);return H(this),o}:void 0},J=Symbol("smart_mutex");class q{constructor(){this.mtx=Promise.resolve()}lock(){let t;const e=new Promise(e=>{t=()=>e()}),r=this.mtx;return this.mtx=e,r.then(function(){return t})}}const K=function(t){return function(e,r){let{kind:n}=r;if("method"==n)return async function(){const r=this;r[J]||(r[J]={}),r[J][t]||(r[J][t]=new q);const n=await r[J][t].lock();let o,i;try{for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];i=await e.call(r,...s)}catch(t){o=t}if(n(),o)throw o;return i}}},z=function(t,e){let{kind:r}=e;if("class"==r){var o;let e,r;return class extends t{constructor(){super(...arguments),e(this)}async[(r=K("list_mutating"),"render")](){const t=await super.render(...arguments),e=this;if(e.sortable=!!e.options.sortable,e.templates.item.setAttribute("draggable",e.sortable),e.children.forEach(t=>t.targetNode.setAttribute("dragable",e.sortable)),e.sortable){let t=null,r=null;e.targetNode.addEventListener("dragstart",e=>{null===t?(t=e.target,e.stopPropagation()):e.preventDefault()}),e.targetNode.addEventListener("dragover",t=>t.preventDefault()),e.targetNode.addEventListener("drop",e=>{if(!t)return;let n=e.target;for(;n.parentElement&&n.parentElement!=t.parentElement;)n=n.parentElement;r=n}),e.targetNode.addEventListener("dragend",async()=>{r&&await e.move({from:e.getComponent(t),to:e.getComponent(r)}),t=null,r=null})}return t}async move(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this;let{from:r,to:n}=t;if(null===n||null===r)return;const o=Number(r?.name),i=Number(n?.name);if(o==i)return;if(o<i){const t=[...e.children.slice(o+1,i+1),e.children[o]];e.children.splice(o,i-o+1,...t)}else if(o>i){const t=[e.children[o],...e.children.slice(i,o)];e.children.splice(i,o-i+1,...t)}const a=(o<i?1:-1)>0?"after":"before";n.targetNode[a](r.targetNode),e.renum()}static#t=(()=>o=()=>([e]=n(this,[[r,2,"move"]],[]).e,this))()},o()}};var G;let W,V,X,Y,Q,Z;class tt extends k{constructor(){super(...arguments),W(this)}async#e(t){const e=this;e.templates.header?e.templates.header.after(t):e.targetNode.appendChild(t)}async[(X=[K("list_mutating"),S,D],Y=[S,K("list_mutating"),B],Q=[S,K("list_mutating"),B],"render")](){const t=this;t.originalDisplayProp=t.targetNode.style.display,t.min_items=Math.max(0,"number"==typeof t.options.min_items?t.options.min_items:1),t.max_items=Math.max(t.min_items,"number"==typeof t.options.max_items?t.options.max_items:1/0),t.children=[],t.templates=function(t){const e={};for(const r of[...t.targetNode.children]){const{role:n="item"}=s(r.getAttribute("data-smark"))||{};switch(n){case"empty_list":case"header":case"separator":case"last_separator":case"footer":case"placeholder":r.setAttribute("data-role",n);case"item":if(void 0!==e[n])throw t.renderError("LIST_DUPLICATE_TEMPLATE",`Repated list template role ${n}`);e[n]=r,e[n].remove()}}if(t.targetNode.children.length){const{role:e="(unspecified)"}=s(t.targetNode.children[0].getAttribute("data-smark"))||{};throw t.renderError("LIST_UNKNOWN_TEMPLATE_ROLE",`Unknown list template role ${e}`)}if(e.last_separator||(e.last_separator=e.separator),null!==e.item.querySelector("[id]"))throw t.renderError("LIST_CONTAINS_ID","List components are not allowed to contain elements with 'id' attribute");return e}(t),t.placeholders=[];const e=t.getNodeOptions(t.templates.item,{type:t.options.of});if(t.options.of&&e.type!=t.options.of)throw t.renderError("LIST_ITEM_TYPE_MISSMATCH","List item type missmatch");for(const e of[t.templates.header,t.templates.footer])if(e){t.targetNode.appendChild(e);for(const r of o(e,t.selector)){const e=await t.enhance(r);if(e?._isField)throw t.renderError("FIELD_IN_WRONG_LIST_TEMPLATE","Fields are not allowed in list's template roles other than item.")}}t.root.onRendered(async()=>{for(let e=0;e<t.min_items;e++)await t.addItem({silent:!0});0==t.min_items&&await t.renum(),t.targetNode.setAttribute("aria-live","polite"),t.targetNode.setAttribute("aria-atomic","true")})}onTriggerRender(t){let{action:e,origin:r,context:n}=t;switch(e){case"addItem":case"removeItem":1+[...r.parents].findIndex(t=>Object.is(t,n))&&r.options.hotkey&&null===(o=r.targetNode).getAttribute("tabindex")&&o.setAttribute("tabindex","-1")}var o}async export(){const t=this,e=[],r=[],n=!t.inherittedOption("exportEmpties",!1);for(const o of t.children)n&&await o.isEmpty()?e.length<t.min_items&&r.push(o):e.push(await o.export({silent:!0}));for(let n=0;e.length<t.min_items;n++)e.push(await r[n].export({silent:!0}));return e}async import(){let{data:t=[],focus:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this;t instanceof Array||(t=[t]);for(let n=0;n<Math.min(t.length,r.max_items);n++)r.children.length<=n&&await r.addItem({silent:!0}),await r.children[n].import({data:t[n],focus:e,silent:!0});for(let e=Math.max(t.length,r.min_items);e<r.children.length;)await r.removeItem({silent:!0});t.length>r.max_items&&r.emit("error",{code:"LIST_IMPORT_OVERFLOW",message:"Trying to import array greater than list's max_items. Data beyond max_items ignored.",context:r,data:t,options:r.options});for(let e=t.length;e<r.children.length;e++)r.children[e].clear({silent:!0});e&&r.focus()}async addItem(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this;if(t.action="addItem",t.origin||=null,t.context||=e,t.source||=null,t.target||=null,t.position||="after",t.autoscroll||=null,t.failback||="throw","after"!=t.position&&"before"!=t.position)throw e.renderError("LIST_WRONG_ADDITEM_POSITION",`Invalid value for addItem() position property: ${t.position}`);if(e.children.length>=e.max_items){if("none"===t.failback);else e.emit("error",{code:"LIST_MAX_ITEMS_REACHED",message:"Cannot add items over max_items boundary",options:t});return}e.children.length&&!t.target&&(t.target="before"==t.position?e.children[0]:e.children[e.children.length-1]);const r=e.templates.item.cloneNode(!0),n=[];let o;if(await e.emit("addItem",{action:t.action,origin:t.origin,context:t.context,target:t.target,position:t.position,newItemTarget:r,options:t,onRendered:t=>n.push(t)}),e.children.length?e.children=(await Promise.all(e.children.map(async(n,i)=>{if(n.targetNode.isSameNode(t.target.targetNode)){n.targetNode[t.position](r),o=await e.enhance(r,{type:"form"}),await o.rendered;const i=[n,o];return"before"==t.position&&i.reverse(),i}return n}))).flat():(await e.#e(r),o=await e.enhance(r,{type:"form",name:0}),await o.rendered,e.children.push(o),o.name=0),await e.renum(),t.source){const e=o.find(t.source);if(e){const t=await e.export();o.import({data:t,silent:!0})}}if("elegant"==t.autoscroll&&o)i(o.targetNode,-o.offsetHeight);else{const e=o?"self"==t.autoscroll?o:"parent"==t.autoscroll?o.parent:null:null;e&&e.moveTo()}return n.forEach(t=>t(o)),e.renderedSync&&o.focus(),o}async removeItem(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this;if(t.action="removeItem",t.origin||=null,t.context||=e,t.target||=null,t.autoscroll||=null,t.keep_non_empty||=!1,t.failback||="throw",!t.target){if(t.keep_non_empty)for(const r of[...e.children].reverse())if(await r.isEmpty()){t.target=r;break}t.target||(t.target=e.children[e.children.length-1],t.keep_non_empty=!1)}const r=t.target instanceof Array?t.target:[t.target];for(const n of[...r].reverse()){if(e.children.length<=e.min_items)switch(t.failback){case"none":break;case"clear":return void await n.clear({silent:!0});default:return void e.emit("error",{code:"LIST_MIN_ITEMS_REACHED",message:"Cannot remove items under min_items boundary",options:t})}if(t.keep_non_empty&&!await n.isEmpty())continue;let r=null,o=null;const a=e.children.filter((e,a,s)=>{if(e.targetNode.isSameNode(n.targetNode)){if("elegant"==t.autoscroll)i(e.targetNode,e.targetNode.offsetHeight);else{const r="self"==t.autoscroll?e:"parent"==t.autoscroll?e.parent:null;r&&r.moveTo()}return r=e,o=s.length-a>1?o=a:0==a?null:a-1,!1}return!0}),s=[];await e.emit("removeItem",{action:t.action,origin:t.origin,context:t.context,target:n,oldItem:r,oldItemTarget:r.targetNode,options:t,onRemoved:t=>s.push(t)}),r.targetNode.remove(),e.children=a,await e.renum(),s.forEach(t=>t()),null!==o&&e.children[o].focus()}}async isEmpty(){const t=this;for(const e of t.children)if(!await e.isEmpty())return!1;return!0}async clear(){let{focus:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return await this.import({data:[],focus:t,silent:!0})}count(){let{delta:t=0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.children.length+Number(t)}position(){let{target:t,offset:e=1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Number(t?.name)+Number(e)}async renum(){const t=this;for(const e in t.children)t.children[e].name=e,t.children[e].updateId();if(t.templates.separator||t.templates.last_separator)for(const e in t.children){const r=e>=t.children.length-1,n=e<=0?null:r?"last_separator":"separator",o=t.children[e].targetNode,i=o.previousElementSibling,a=i&&i.getAttribute("data-role");if(a!==n){a&&i.remove();const e=t.templates[n];n&&e&&o.parentElement.insertBefore(e.cloneNode(!0),o)}if(r){const t=o.nextElementSibling;t&&t.remove()}}if(t.templates.empty_list&&(t.children.length?t.templates.empty_list.remove():await t.#e(t.templates.empty_list)),t.templates.placeholder&&t.max_items){let e=(t.max_items||0)-t.children.length;if(e>0&&0===t.children.length&&t.templates.empty_list&&e--,t.placeholders.length<e)for(let r=t.placeholders.length;r<e;r++){const e=t.templates.placeholder.cloneNode(!0);t.templates.footer?t.templates.footer.before(e):t.targetNode.appendChild(e),t.placeholders.push(e)}else for(let r=t.placeholders.length;r>e;r--)t.placeholders.pop().remove()}t.getTriggers("position").forEach(t=>{const e=t.getTriggerArgs();t.targetNode.innerText=this.position({...e,silent:!0})}),t.getTriggers("count").forEach(t=>{const e=t.getTriggerArgs();t.targetNode.innerText=this.count({...e,silent:!0})})}static#t=(()=>G=()=>(({e:[W],c:[Z,V]}=n(this,[[X,2,"export"],[[S,F],2,"import"],[Y,2,"addItem"],[Q,2,"removeItem"],[S,2,"clear"],[S,2,"count"],[S,2,"position"]],[P,z,B])),V()))()}var et;let rt;G();class nt extends M{constructor(){rt(super(...arguments));this.eventHooks.keydown.push(function(t){if(!t.defaultPrevented&&"Enter"===t.originalEvent.key){const e=t.originalEvent.shiftKey;if("TEXTAREA"===t.context.targetNode.tagName&&!t.originalEvent.ctrlKey&&!e)return;let r=e?t.context.find(".-1")||t.context.find("../.-1"):t.context.find(".+1")||t.context.find("../.+1");r&&(r.focus(),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation())}})}async render(){const t=this;if(t.isSingleton=!("INPUT"===t.targetNode.tagName||"SELECT"===t.targetNode.tagName||"TEXTAREA"===t.targetNode.tagName),t.isCheckbox=!t.isSingleton&&"checkbox"==String(t.targetNode.type).toLowerCase(),t.isSingleton){await super.render();const e=Object.values(t.children);if(1!=e.length)throw t.renderError("NOT_A_SINGLETON",`Singleton forms are only allowed to contain exactly one data field but ${e.length} found.`);const r=e[0];if(t.options.type!==r.options.type)throw t.renderError("SINGLETON_TYPE_MISMATCH",`Singleton type (${t.options.type}) does not match child field type (${r.options.type}).`);t.targetFieldNode=r.targetNode}else t.targetFieldNode=t.targetNode}async export(t){const e=this;if(e.isSingleton)return await e.children[""].export(t);const r=e.targetFieldNode;let n;return n=e.isCheckbox?!!r.checked:"json"===e.options.encoding&&"SELECT"===r.tagName.toUpperCase()&&null===r.options[r.selectedIndex]?.getAttribute("value")?JSON.stringify(r.options[r.selectedIndex].text):r.value,"json"===e.options.encoding?s(n)||null:n}async import(t){const e=this;if(e.isSingleton)return await e.children[""].import(t);let{data:r="",focus:n=!0}=t||{};const o=e.targetFieldNode;if("object"==typeof r&&"input"===e.options.type||"json"===e.options.encoding){r||=null;r=("TEXTAREA"===o.tagName.toUpperCase()?JSON.stringify(r,null,4):JSON.stringify(r))||""}if(e.isCheckbox)e.targetNode.checked=!!r;else if("json"===e.options.encoding&&"SELECT"===o.tagName.toUpperCase()){if(e.targetNode.value=r||"null",-1===o.selectedIndex){const t=s(r)||"",e=Array.from(o.options).findIndex(e=>e.text===t);-1!==e&&(o.selectedIndex=e)}}else e.targetNode.value=r;return n&&e.focus(),e.targetNode.value}async isEmpty(){return!(this.isCheckbox?"":await this.export()).trim().length}async clear(){let{focus:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};await this.import({data:"json"===this.options.encoding?null:"",focus:t})}static#t=(()=>et=()=>[rt]=n(this,[[[S,D],2,"export"],[[S,F],2,"import"],[S,2,"clear"]],[]).e)()}var ot;let it;et();class at extends nt{constructor(){super(...arguments),it(this)}async render(){await super.render();const t=this,e=t.targetFieldNode.tagName,r=t.targetFieldNode.getAttribute("type");if("INPUT"!=e||"number"!=(r||"number").toLowerCase())throw t.renderError("NOT_A_NUMBER_FIELD",'Number inputs require an INPUT tag of type "number".');r||(t.targetFieldNode.type="number")}async export(){const t=await super.export(...arguments);return this.isSingleton?t:t.length&&!isNaN(t)?Number(t):null}async import(){let{data:t=null,focus:e=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=typeof t;if(this.isSingleton)return await super.import({data:t,focus:e});return await super.import({data:"number"==r?t:"string"==r&&t.length&&!isNaN(t)?Number(t):null,focus:e})}async isEmpty(){return null===await this.export()}static#t=(()=>ot=()=>[it]=n(this,[[S,2,"export"],[S,2,"import"]],[]).e)()}var st;let lt;ot();const ct=/T.*/;function dt(t){return 8==t.length?new Date([t.substring(0,4),t.substring(4,6),t.substring(6,8)].join("-")):10==t.length&&"-"==t[4]&&"-"==t[7]?new Date(t):NaN}function ut(t){return t.toISOString().replace(ct,"")}class pt extends nt{constructor(){super(...arguments),lt(this)}async render(){await super.render();const t=this,e=t.targetFieldNode.tagName,r=t.targetFieldNode.getAttribute("type");if("INPUT"!=e||"date"!=(r||"date").toLowerCase())throw t.renderError("NOT_A_DATE_FIELD",'Date inputs require an INPUT tag of type "date".');r||(t.targetFieldNode.type="date")}async export(){const t=await super.export(...arguments);if(this.isSingleton)return t;if(!t.length)return null;const e=dt(t);return isNaN(e)?null:ut(e)}async import(){let{data:t=null,focus:e=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.isSingleton)return await super.import({data:t,focus:e});const r=t instanceof Date?t:"number"==typeof t?new Date(t):t&&"string"==typeof t?dt(t):NaN;return await super.import({data:isNaN(r)?null:ut(r),focus:e})}async isEmpty(){return null===await this.export()}static#t=(()=>st=()=>[lt]=n(this,[[S,2,"export"],[S,2,"import"]],[]).e)()}var ft;let gt;st();class ht extends nt{constructor(){gt(super(...arguments));const t=this;let e=t.parent.children[t.name],r=t;e?(t.targetNode.setAttribute("name",e.sharedNodeName),e.radioButtons.push(t.targetNode),r={}):(e=t,e.sharedNodeName=a(),e.targetNode.setAttribute("name",e.sharedNodeName),e.radioButtons=[e.targetNode]);let n=mt.bind(e);return t.targetNode.addEventListener("click",n),t.targetNode.addEventListener("keydown",n),r}async render(){await super.render();const t=this,e=t.targetFieldNode.tagName,r=t.targetFieldNode.getAttribute("type");if("INPUT"!=e||"radio"!=(r||"radio").toLowerCase())throw t.renderError("NOT_A_RADIO_FIELD",'Radio inputs require an INPUT tag of type "radio".');r||(t.targetFieldNode.type="radio")}async export(){return this.radioButtons.find(t=>t.checked)?.value||null}async import(){let{data:t=null,focus:e=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this.radioButtons.find(e=>e.value===t);r?r.checked=!0:this.radioButtons.forEach(t=>t.checked=!1),e&&this.focus()}async isEmpty(){return!(1+this.radioButtons.findIndex(t=>t.checked))}static#t=(()=>ft=()=>[gt]=n(this,[[[S,D],2,"export"],[[S,F],2,"import"]],[]).e)()}function mt(t){if("click"===t.type||"keydown"===t.type&&"Delete"===t.code){const e=this;let r=!0;Object.is(e.lastClicked?.target,t.target)&&(r=!e.lastClicked.checked&&"keydown"!==t.type),e.lastClicked={target:t.target,checked:r},t.target.checked=r}}var yt;let Nt;ft();const vt=/^#([a-f0-9]{3}){1,2}$/i,wt="\n    opacity: .5;\n    background: repeating-linear-gradient(\n            45deg,\n            black,\n            black 10px,\n            white 10px,\n            white 20px\n        ),\n        black;\n    background-blend-mode: difference;\n";class bt extends nt{constructor(){Nt(super(...arguments)),this.eventHooks.keydown.push(t=>{t.defaultPrevented||"Delete"===t.originalEvent.key&&t.context.clear()})}async render(){await super.render();const t=this;if(t.isSingleton)return;const e=t.targetFieldNode.tagName,r=t.targetFieldNode.getAttribute("type");if("INPUT"!=e||"color"!=(r||"color").toLowerCase())throw t.renderError("NOT_A_COLOR_FIELD",'Color inputs require an INPUT tag of type "color".');r||(t.targetFieldNode.type="color");const n=t.targetFieldNode.getAttribute("value");t.isDefined=null!==n&&""!==n.trim(),t.defaultStyleAttr=t.targetFieldNode.getAttribute("style")+";",t.isDefined||t.targetFieldNode.setAttribute("style",t.defaultStyleAttr+wt);const o=e=>{"Enter"!==e.code&&"Space"!==e.Code&&void 0!==e.code||(t.isDefined=!0,t.targetFieldNode.setAttribute("style",t.defaultStyleAttr))};t.targetFieldNode.addEventListener("keydown",o),t.targetFieldNode.addEventListener("click",o),t.targetFieldNode.addEventListener("change",o)}async export(){let t=await super.export(...arguments);return this.isSingleton||(t=this.isDefined&&t.match(vt)?t.toLowerCase():null),t}async import(){let{data:t=null,focus:e=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=this;r.isSingleton||(null!==t&&t.match(vt)?(r.isDefined=!0,r.targetFieldNode.setAttribute("style",r.defaultStyleAttr)):(r.isDefined=!1,r.targetFieldNode.setAttribute("style",r.defaultStyleAttr+wt))),4==t?.length&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}`);const n=await super.import({data:t,focus:e});return r.isDefined?n:null}async isEmpty(){return null===await this.export()}static#t=(()=>yt=()=>[Nt]=n(this,[[S,2,"export"],[S,2,"import"]],[]).e)()}yt();for(const[t,e]of Object.entries({trigger:O,label:C,form:M,list:Z,input:nt,number:at,date:pt,radio:ht,color:bt}))T(t,e);class Et extends M{constructor(t){let{customActions:e={},...r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n={...r,name:"",type:"form"};super(t,n,null);const o=this;o.setNodeOptions(o.targetNode,n),o.actions={...o.actions,...Object.fromEntries(Object.entries(e).map(t=>{let[e,r]=t;return[e,r.bind(o)]}))},o.targetNode.addEventListener("click",L.bind(o),!0),new I(o)}async render(){this.targetNode.setAttribute("aria-busy","true"),await super.render(),this.targetNode.setAttribute("aria-busy","false")}}Et.createType=T;export{Et as default};//# sourceMappingURL=SmarkForm.esm.js.map
